<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geoffrey's Task Board</title>
  <meta name="description" content="Butler-themed task management for Master Matt">
  <meta name="theme-color" content="#0d1117">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.svg">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --gold: #d4af37;
      --gold-dark: #aa8c2c;
      --gold-light: #f4d03f;
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --bg-hover: #21262d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --red: #f85149;
      --orange: #d29922;
      --green: #3fb950;
      --blue: #58a6ff;
      --purple: #a371f7;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-dark);
      min-height: 100vh;
      color: var(--text);
      overflow-x: hidden;
    }

    .bg-pattern {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 40% 80%, rgba(212, 175, 55, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1500px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* Connection Status */
    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 100;
      transition: all 0.3s;
    }

    .connection-status.connected { background: rgba(63, 185, 80, 0.2); color: var(--green); }
    .connection-status.disconnected { background: rgba(248, 81, 73, 0.2); color: var(--red); }
    .connection-status.syncing { background: rgba(210, 153, 34, 0.2); color: var(--orange); }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .syncing .status-dot { animation: pulse-dot 1s infinite; }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Header */
    header {
      text-align: center;
      padding: 40px 20px;
    }

    .logo {
      font-size: 4rem;
      margin-bottom: 10px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.8rem;
      color: var(--gold);
      font-weight: 600;
      letter-spacing: 1px;
      text-shadow: 0 2px 20px rgba(212, 175, 55, 0.3);
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--text-muted);
      margin-top: 8px;
      font-style: italic;
    }

    /* Geoffrey's wisdom */
    .geoffrey-says {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 16px;
      padding: 20px 30px;
      margin: 30px auto;
      max-width: 700px;
      display: flex;
      align-items: center;
      gap: 20px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .geoffrey-avatar { font-size: 3rem; flex-shrink: 0; }

    .geoffrey-quote {
      font-style: italic;
      color: var(--text);
      line-height: 1.6;
    }

    .geoffrey-quote .signature {
      display: block;
      margin-top: 8px;
      color: var(--gold);
      font-style: normal;
      font-size: 0.9rem;
    }

    /* Category Tabs */
    .category-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 4px 0;
    }

    .category-tabs::-webkit-scrollbar { display: none; }

    .category-tab {
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      color: var(--text-muted);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .category-tab:hover { border-color: var(--gold); color: var(--gold); }

    .category-tab.active {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      color: var(--bg-dark);
      border-color: transparent;
      font-weight: 600;
    }

    /* Board */
    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-top: 20px;
    }

    @media (max-width: 1024px) { .board { grid-template-columns: 1fr; } }

    .column {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }

    .column.drag-over {
      border-color: var(--gold);
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid;
    }

    .column-header h2 {
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .column-header .count {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .column.todo .column-header { border-color: var(--red); }
    .column.todo .column-header h2 { color: var(--red); }
    .column.in-progress .column-header { border-color: var(--orange); }
    .column.in-progress .column-header h2 { color: var(--orange); }
    .column.done .column-header { border-color: var(--green); }
    .column.done .column-header h2 { color: var(--green); }

    .task-list {
      min-height: 150px;
      max-height: 500px;
      overflow-y: auto;
    }

    .task-list::-webkit-scrollbar { width: 6px; }
    .task-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }

    /* Task Cards */
    .task {
      background: var(--bg-hover);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: grab;
      transition: all 0.2s ease;
      border-left: 4px solid var(--gold);
      position: relative;
      overflow: hidden;
    }

    .task::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .task:hover::before { opacity: 1; }

    .task:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .task.dragging { opacity: 0.5; transform: rotate(3deg) scale(1.05); cursor: grabbing; }
    .task.completed { opacity: 0.7; }
    .task.completed .task-title { text-decoration: line-through; color: var(--text-muted); }

    .task-category {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--purple);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .task-title {
      font-size: 1rem;
      margin-bottom: 12px;
      color: var(--text);
      font-weight: 500;
      line-height: 1.4;
    }

    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      flex-wrap: wrap;
      gap: 8px;
    }

    .task-source { font-size: 0.7rem; opacity: 0.6; }
    .task-due { display: flex; align-items: center; gap: 4px; }
    .task-due.overdue { color: var(--red); }
    .task-due.soon { color: var(--orange); }

    .task-priority {
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: 600;
    }

    .priority-high { 
      background: rgba(248, 81, 73, 0.2); 
      color: var(--red);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(248, 81, 73, 0); }
    }

    .priority-medium { background: rgba(210, 153, 34, 0.2); color: var(--orange); }
    .priority-low { background: rgba(63, 185, 80, 0.2); color: var(--green); }

    .task-actions {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      opacity: 0;
      transform: translateY(5px);
      transition: all 0.2s ease;
    }

    .task:hover .task-actions { opacity: 1; transform: translateY(0); }

    .task-actions button {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .task-actions button:hover { background: rgba(212, 175, 55, 0.2); border-color: var(--gold); color: var(--gold); }
    .task-actions button.delete:hover { background: rgba(248, 81, 73, 0.2); border-color: var(--red); color: var(--red); }

    /* Add Task */
    .add-task-btn {
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 2px dashed rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
      margin-top: 15px;
    }

    .add-task-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.05); }

    .add-task-form {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 15px;
      display: none;
      animation: slideDown 0.3s ease;
    }

    .add-task-form.active { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .add-task-form input,
    .add-task-form select,
    .add-task-form textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }

    .add-task-form textarea { resize: none; height: 80px; margin-bottom: 10px; }
    .add-task-form input:focus, .add-task-form select:focus, .add-task-form textarea:focus { outline: none; border-color: var(--gold); }

    .form-buttons { display: flex; gap: 10px; }

    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--bg-dark); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255, 255, 255, 0.05); color: var(--text-muted); border: 1px solid rgba(255, 255, 255, 0.1); }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 40px;
    }

    @media (max-width: 768px) { .stats { grid-template-columns: repeat(2, 1fr); } }

    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s;
    }

    .stat-card:hover { transform: translateY(-5px); border-color: rgba(212, 175, 55, 0.3); }
    .stat-icon { font-size: 2rem; margin-bottom: 10px; }
    .stat-value { font-size: 2.5rem; font-weight: 600; color: var(--gold); font-family: 'Playfair Display', serif; }
    .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, var(--bg-card), var(--bg-hover));
      border: 1px solid var(--gold);
      border-radius: 16px;
      padding: 20px 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      transform: translateY(150%);
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 1000;
    }

    .toast.show { transform: translateY(0); }
    .toast-icon { font-size: 2.5rem; }
    .toast-content h3 { color: var(--gold); font-size: 1.1rem; margin-bottom: 4px; }
    .toast-content p { color: var(--text-muted); font-size: 0.9rem; }

    .confetti { position: fixed; width: 10px; height: 10px; pointer-events: none; z-index: 999; }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }
    .empty-state p { font-style: italic; }

    /* Bulk Actions */
    .bulk-actions {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 12px;
      margin-bottom: 15px;
      animation: slideDown 0.3s ease;
    }

    .bulk-actions.active { display: flex; }

    .bulk-actions .selected-count {
      font-size: 0.85rem;
      color: var(--gold);
      font-weight: 500;
    }

    .bulk-actions .bulk-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: var(--bg-hover);
      color: var(--text);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .bulk-actions .bulk-btn:hover {
      background: rgba(212, 175, 55, 0.2);
      border-color: var(--gold);
    }

    .bulk-actions .bulk-btn.danger:hover {
      background: rgba(248, 81, 73, 0.2);
      border-color: var(--red);
      color: var(--red);
    }

    .bulk-actions .select-all-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
      cursor: pointer;
    }

    /* Task checkbox */
    .task-checkbox {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--gold);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .task:hover .task-checkbox,
    .task-checkbox:checked { opacity: 1; }

    .task.selected {
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.3);
    }

    .clear-completed-btn {
      width: 100%;
      padding: 10px;
      background: rgba(248, 81, 73, 0.1);
      border: 1px dashed rgba(248, 81, 73, 0.3);
      border-radius: 8px;
      color: var(--red);
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 12px;
      transition: all 0.3s;
      display: none;
    }

    .clear-completed-btn.visible { display: block; }
    .clear-completed-btn:hover { background: rgba(248, 81, 73, 0.2); border-color: var(--red); }

    /* Main Navigation Tabs */
    .main-nav {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--bg-dark);
      padding: 12px 0 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .main-nav::-webkit-scrollbar { display: none; }

    .main-nav-tab {
      background: var(--bg-card);
      border: 2px solid rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .main-nav-tab:hover { border-color: var(--gold); color: var(--gold); }

    .main-nav-tab.active {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.1));
      border-color: var(--gold);
      color: var(--gold);
    }

    .main-nav-tab .badge {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
    }

    .main-nav-tab.active .badge {
      background: var(--gold);
      color: var(--bg-dark);
    }

    /* View containers */
    .view-container { display: none; animation: fadeIn 0.3s ease; }
    .view-container.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Mobile bottom nav */
    @media (max-width: 768px) {
      .main-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        margin: 0;
        padding: 8px 10px;
        background: var(--bg-card);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: none;
        border-radius: 0;
        justify-content: space-around;
        gap: 4px;
        z-index: 100;
      }

      .main-nav-tab {
        flex-direction: column;
        padding: 6px 10px;
        font-size: 0.65rem;
        border: none;
        background: transparent;
        gap: 2px;
        border-radius: 8px;
      }

      .main-nav-tab .tab-emoji {
        font-size: 1.3rem;
      }

      .main-nav-tab .tab-label {
        font-size: 0.6rem;
      }

      .main-nav-tab:hover { border-color: transparent; }

      .main-nav-tab.active {
        background: rgba(212, 175, 55, 0.15);
        border-color: transparent;
      }

      .main-nav-tab .badge {
        position: absolute;
        top: -2px;
        right: -2px;
        font-size: 0.6rem;
        padding: 1px 5px;
        min-width: 16px;
        text-align: center;
      }

      .container {
        padding-bottom: 80px;
      }
    }

    /* Ideas Board */
    .ideas-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-top: 20px;
    }

    @media (max-width: 1024px) { .ideas-board { grid-template-columns: 1fr; } }

    .idea-column {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .idea-column.new .column-header { border-color: var(--blue); }
    .idea-column.new .column-header h2 { color: var(--blue); }
    .idea-column.exploring .column-header { border-color: var(--purple); }
    .idea-column.exploring .column-header h2 { color: var(--purple); }
    .idea-column.planned .column-header { border-color: var(--green); }
    .idea-column.planned .column-header h2 { color: var(--green); }

    /* Idea Cards */
    .idea {
      background: var(--bg-hover);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid var(--blue);
      position: relative;
    }

    .idea:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .idea.status-exploring { border-left-color: var(--purple); }
    .idea.status-planned { border-left-color: var(--green); }

    .idea-category {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--blue);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .idea.status-exploring .idea-category { color: var(--purple); }
    .idea.status-planned .idea-category { color: var(--green); }

    .idea-title {
      font-size: 1rem;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 500;
      line-height: 1.4;
    }

    .idea-description {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .idea-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .idea-has-notes {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--gold);
    }

    .idea-actions {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      opacity: 0;
      transition: all 0.2s ease;
    }

    .idea:hover .idea-actions { opacity: 1; }

    /* Idea Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--bg-card);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: var(--gold);
      font-size: 1.2rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .modal-close:hover { background: rgba(255, 255, 255, 0.1); color: var(--text); }

    .modal-body { padding: 24px; }

    .modal-field {
      margin-bottom: 20px;
    }

    .modal-field label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .modal-field input,
    .modal-field select,
    .modal-field textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg-hover);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }

    .modal-field textarea {
      min-height: 120px;
      resize: vertical;
    }

    .modal-field input:focus,
    .modal-field select:focus,
    .modal-field textarea:focus {
      outline: none;
      border-color: var(--gold);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Archive View */
    .archive-toggle {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .archive-toggle button {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .archive-toggle button:hover { border-color: var(--gold); color: var(--gold); }

    .archived-ideas {
      display: none;
      margin-top: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
    }

    .archived-ideas.visible { display: block; }

    .archived-ideas h3 {
      color: var(--text-muted);
      margin-bottom: 16px;
      font-size: 1rem;
    }

    .archived-idea {
      opacity: 0.6;
      border-left-color: var(--text-muted) !important;
    }

    .archived-idea:hover { opacity: 0.8; }

    /* Ideas Category Filter */
    .idea-category-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 4px 0;
    }

    .idea-category-tabs::-webkit-scrollbar { display: none; }

    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s;
    }

    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loading-spinner { font-size: 4rem; animation: spin 2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .loading-text { margin-top: 20px; color: var(--text-muted); font-style: italic; }

    footer { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 0.9rem; }
    footer a { color: var(--gold); text-decoration: none; }

    .shortcut-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .shortcut-hint kbd { background: var(--bg-hover); padding: 3px 8px; border-radius: 4px; font-family: monospace; }

    /* Custom Tooltips */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--gold);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: normal;
      text-transform: none;
      letter-spacing: normal;
      white-space: nowrap;
      max-width: 280px;
      white-space: normal;
      text-align: center;
      line-height: 1.4;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    [data-tooltip]::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--gold);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1001;
    }

    [data-tooltip]:hover::after,
    [data-tooltip]:hover::before {
      opacity: 1;
      visibility: visible;
    }

    /* Tooltip position variants */
    [data-tooltip-pos="bottom"]::after {
      bottom: auto;
      top: calc(100% + 10px);
    }

    [data-tooltip-pos="bottom"]::before {
      bottom: auto;
      top: calc(100% + 4px);
      border-top-color: transparent;
      border-bottom-color: var(--gold);
    }

    [data-tooltip-pos="left"]::after {
      bottom: auto;
      top: 50%;
      left: auto;
      right: calc(100% + 10px);
      transform: translateY(-50%);
    }

    [data-tooltip-pos="left"]::before {
      bottom: auto;
      top: 50%;
      left: auto;
      right: calc(100% + 4px);
      transform: translateY(-50%);
      border-top-color: transparent;
      border-left-color: var(--gold);
    }

    @media (max-width: 768px) {
      .shortcut-hint { display: none; }
      h1 { font-size: 1.5rem; }
      .logo { font-size: 2.5rem; }
      .subtitle { font-size: 0.8rem; }
      header { padding: 20px 10px; }
      .geoffrey-says { margin: 10px auto 15px; padding: 12px 16px; font-size: 0.85rem; }
      .container { padding: 10px; }
      .column { padding: 14px; }
      .board { gap: 16px; }
      .notes-filters .category-tab,
      .idea-category-tabs .category-tab,
      .category-tabs .category-tab {
        padding: 8px 14px;
        font-size: 0.8rem;
      }
    }

    /* ===== NOTES VIEW ===== */
    .notes-filters {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 4px 0;
    }

    .notes-filters::-webkit-scrollbar { display: none; }

    .notes-list {
      max-width: 900px;
      margin: 0 auto;
    }

    .note-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 12px;
      border-left: 4px solid var(--gold);
      transition: all 0.2s ease;
    }

    .note-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 10px;
    }

    .note-title {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      flex: 1;
    }

    .note-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .badge-pill {
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .badge-project {
      background: rgba(88, 166, 255, 0.2);
      color: var(--blue);
    }

    .badge-project.project-klass { background: rgba(163, 113, 247, 0.2); color: var(--purple); }
    .badge-project.project-touchgrass { background: rgba(63, 185, 80, 0.2); color: var(--green); }
    .badge-project.project-timeslot { background: rgba(210, 153, 34, 0.2); color: var(--orange); }
    .badge-project.project-general { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }

    .badge-type {
      background: rgba(212, 175, 55, 0.15);
      color: var(--gold);
    }

    .note-content-preview {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .note-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .note-actions {
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .note-card:hover .note-actions { opacity: 1; }

    .note-actions button {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .note-actions button:hover {
      background: rgba(212, 175, 55, 0.2);
      border-color: var(--gold);
      color: var(--gold);
    }

    .note-actions button.delete:hover {
      background: rgba(248, 81, 73, 0.2);
      border-color: var(--red);
      color: var(--red);
    }

    .add-note-form {
      max-width: 900px;
      margin: 0 auto 20px;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: none;
      animation: slideDown 0.3s ease;
    }

    .add-note-form.active { display: block; }

    .add-note-btn {
      max-width: 900px;
      margin: 0 auto 20px;
      display: block;
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 2px dashed rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }

    .add-note-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
      background: rgba(212, 175, 55, 0.05);
    }

    /* ===== PIPELINE VIEW ===== */
    .pipeline-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 1200px) { .pipeline-board { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .pipeline-board { grid-template-columns: 1fr; } }

    .pipeline-column {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s;
    }

    .pipeline-column.drag-over {
      border-color: var(--gold);
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
    }

    .pipeline-column.status-idea .column-header { border-color: var(--blue); }
    .pipeline-column.status-idea .column-header h2 { color: var(--blue); }
    .pipeline-column.status-draft .column-header { border-color: var(--orange); }
    .pipeline-column.status-draft .column-header h2 { color: var(--orange); }
    .pipeline-column.status-ready .column-header { border-color: var(--purple); }
    .pipeline-column.status-ready .column-header h2 { color: var(--purple); }
    .pipeline-column.status-published .column-header { border-color: var(--green); }
    .pipeline-column.status-published .column-header h2 { color: var(--green); }

    .pipeline-card {
      background: var(--bg-hover);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: grab;
      transition: all 0.2s ease;
      border-left: 4px solid var(--gold);
      position: relative;
    }

    .pipeline-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .pipeline-card.dragging { opacity: 0.5; transform: rotate(3deg); cursor: grabbing; }

    .pipeline-card-type {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--blue);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .pipeline-card-title {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 8px;
    }

    .pipeline-card-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .pipeline-card-platform {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      background: rgba(212, 175, 55, 0.15);
      color: var(--gold);
      font-weight: 500;
    }

    .pipeline-card-project {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      background: rgba(88, 166, 255, 0.15);
      color: var(--blue);
      font-weight: 500;
    }

    .pipeline-card-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .pipeline-card:hover .pipeline-card-actions { opacity: 1; }

    .pipeline-card-actions button {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .pipeline-card-actions button:hover {
      background: rgba(212, 175, 55, 0.2);
      border-color: var(--gold);
      color: var(--gold);
    }

    .pipeline-card-actions button.delete:hover {
      background: rgba(248, 81, 73, 0.2);
      border-color: var(--red);
      color: var(--red);
    }

    .pipeline-list {
      min-height: 100px;
      max-height: 500px;
      overflow-y: auto;
    }

    .pipeline-list::-webkit-scrollbar { width: 6px; }
    .pipeline-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }

    .add-pipeline-form {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 15px;
      display: none;
      animation: slideDown 0.3s ease;
    }

    .add-pipeline-form.active { display: block; }

    /* ===== TODAY VIEW ===== */
    .today-view {
      max-width: 900px;
      margin: 0 auto;
    }

    .today-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .today-date {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      color: var(--gold);
      margin-bottom: 5px;
    }

    .today-subtitle {
      color: var(--text-muted);
      font-style: italic;
    }

    .today-summary {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) { .today-summary { grid-template-columns: repeat(2, 1fr); } }

    .today-stat {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s;
    }

    .today-stat:hover {
      transform: translateY(-3px);
      border-color: rgba(212, 175, 55, 0.3);
    }

    .today-stat-value {
      font-size: 2rem;
      font-weight: 600;
      color: var(--gold);
      font-family: 'Playfair Display', serif;
    }

    .today-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    .today-section {
      margin-bottom: 24px;
    }

    .today-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .today-section-header h3 {
      font-size: 1rem;
      color: var(--text);
      font-weight: 600;
    }

    .today-section-header .section-count {
      background: rgba(212, 175, 55, 0.2);
      color: var(--gold);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .today-item {
      background: var(--bg-card);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-left: 3px solid var(--gold);
      transition: all 0.2s;
    }

    .today-item:hover {
      transform: translateX(4px);
    }

    .today-item-icon { font-size: 1.2rem; flex-shrink: 0; }
    .today-item-title { flex: 1; font-size: 0.9rem; color: var(--text); }
    .today-item-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    .today-item-time { font-size: 0.75rem; color: var(--text-muted); flex-shrink: 0; }

    .today-empty {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
    }

    .today-empty .icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading">
    <div class="loading-spinner">üé©</div>
    <p class="loading-text">Geoffrey is preparing the board...</p>
  </div>

  <div class="connection-status disconnected" id="connection-status" data-tooltip="Shows sync status with Supabase cloud database. Green = synced, Orange = syncing, Red = offline (using local storage)" data-tooltip-pos="bottom">
    <span class="status-dot"></span>
    <span class="status-text">Offline</span>
  </div>

  <div class="bg-pattern"></div>
  
  <div class="container">
    <header>
      <div class="logo">üé©</div>
      <h1>Geoffrey's Task Board</h1>
      <p class="subtitle">Maintaining order in the chaos, one task at a time</p>
    </header>

    <div class="geoffrey-says" data-tooltip="Geoffrey's daily wisdom ‚Äî refreshes each time you load the page" data-tooltip-pos="bottom">
      <div class="geoffrey-avatar">üßê</div>
      <div class="geoffrey-quote">
        <span id="quote-text">Loading wisdom...</span>
        <span class="signature">‚Äî Geoffrey</span>
      </div>
    </div>

    <!-- Main Navigation -->
    <div class="main-nav">
      <button class="main-nav-tab active" data-view="tasks" onclick="switchView('tasks')">
        <span class="tab-emoji">üìã</span> <span class="tab-label">Tasks</span> <span class="badge" id="tasks-badge">0</span>
      </button>
      <button class="main-nav-tab" data-view="ideas" onclick="switchView('ideas')">
        <span class="tab-emoji">üí°</span> <span class="tab-label">Ideas</span> <span class="badge" id="ideas-badge">0</span>
      </button>
      <button class="main-nav-tab" data-view="notes" onclick="switchView('notes')">
        <span class="tab-emoji">üìù</span> <span class="tab-label">Notes</span> <span class="badge" id="notes-badge">0</span>
      </button>
      <button class="main-nav-tab" data-view="pipeline" onclick="switchView('pipeline')">
        <span class="tab-emoji">üì§</span> <span class="tab-label">Pipeline</span> <span class="badge" id="pipeline-badge">0</span>
      </button>
      <button class="main-nav-tab" data-view="today" onclick="switchView('today')">
        <span class="tab-emoji">üìÖ</span> <span class="tab-label">Today</span>
      </button>
    </div>

    <!-- Tasks View -->
    <div id="tasks-view" class="view-container active">

    <div class="category-tabs">
      <button class="category-tab active" data-category="all" data-tooltip="Show all tasks regardless of category">üè† All Tasks</button>
      <button class="category-tab" data-category="work" data-tooltip="9-5 job tasks ‚Äî medical billing, company projects">üíº Work</button>
      <button class="category-tab" data-category="hustle" data-tooltip="Side projects ‚Äî apps, content, revenue streams">üöÄ Side Hustle</button>
      <button class="category-tab" data-category="personal" data-tooltip="Life stuff ‚Äî gym, errands, self-care">üßò Personal</button>
      <button class="category-tab" data-category="urgent" data-tooltip="Drop everything ‚Äî needs immediate attention">üî• Urgent</button>
    </div>

    <div class="board">
      <div class="column todo" data-status="todo">
        <div class="column-header" data-tooltip="Tasks waiting to be started. Drag to In Progress when you begin work.">
          <h2>üìã Awaiting Action</h2>
          <span class="count" data-tooltip="Number of pending tasks" data-tooltip-pos="left">0</span>
        </div>
        <div class="task-list"></div>
        <button class="add-task-btn" onclick="toggleForm(this)" data-tooltip="Click to add a new task, or press 'N' on your keyboard">+ Add a task, sir</button>
        <div class="add-task-form">
          <textarea class="task-input" placeholder="What requires attention, Master Matt?"></textarea>
          <div class="form-row">
            <select class="category-select">
              <option value="work">üíº Work</option>
              <option value="hustle">üöÄ Side Hustle</option>
              <option value="personal">üßò Personal</option>
              <option value="urgent">üî• Urgent</option>
            </select>
            <select class="priority-select">
              <option value="low">üü¢ Low Priority</option>
              <option value="medium" selected>üü° Medium Priority</option>
              <option value="high">üî¥ High Priority</option>
            </select>
          </div>
          <div class="form-row">
            <input type="date" class="due-date">
            <input type="time" class="due-time">
          </div>
          <div class="form-buttons">
            <button class="btn btn-secondary" onclick="toggleForm(this)">Cancel</button>
            <button class="btn btn-primary" onclick="addTask(this)">Add Task</button>
          </div>
        </div>
      </div>

      <div class="column in-progress" data-status="in-progress">
        <div class="column-header" data-tooltip="Tasks currently being worked on. Geoffrey auto-moves tasks here when he starts working.">
          <h2>‚ö° In Progress</h2>
          <span class="count" data-tooltip="Active tasks" data-tooltip-pos="left">0</span>
        </div>
        <div class="task-list"></div>
      </div>

      <div class="column done" data-status="done">
        <div class="column-header" data-tooltip="Completed tasks. Drag here or use arrow buttons to mark done. Triggers confetti! üéâ">
          <h2>‚ú® Accomplished</h2>
          <span class="count" data-tooltip="Completed tasks" data-tooltip-pos="left">0</span>
        </div>
        <div class="bulk-actions" id="bulk-actions">
          <label class="select-all-label">
            <input type="checkbox" id="select-all-done" onchange="toggleSelectAll(this.checked)">
            Select All
          </label>
          <span class="selected-count"><span id="selected-count">0</span> selected</span>
          <button class="bulk-btn danger" onclick="bulkDeleteSelected()">üóëÔ∏è Delete Selected</button>
        </div>
        <div class="task-list"></div>
        <button class="clear-completed-btn" id="clear-completed" onclick="clearAllCompleted()">üßπ Clear All Completed Tasks</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card" data-tooltip="All tasks ever created (todo + in-progress + done)">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="total-tasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-card" data-tooltip="Tasks you've crushed. The number that actually matters.">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-value" id="completed-tasks">0</div>
        <div class="stat-label">Completed</div>
      </div>
      <div class="stat-card" data-tooltip="Completed √∑ Total √ó 100. Aim for progress, not perfection.">
        <div class="stat-icon">üìà</div>
        <div class="stat-value" id="completion-rate">0%</div>
        <div class="stat-label">Success Rate</div>
      </div>
      <div class="stat-card" data-tooltip="Consecutive days completing at least one task. Don't break the chain!">
        <div class="stat-icon">üî•</div>
        <div class="stat-value" id="streak">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>

    </div><!-- End Tasks View -->

    <!-- Ideas View -->
    <div id="ideas-view" class="view-container">
      
      <div class="idea-category-tabs">
        <button class="category-tab active" data-idea-category="all">üí° All Ideas</button>
        <button class="category-tab" data-idea-category="app">üì± App</button>
        <button class="category-tab" data-idea-category="content">üé¨ Content</button>
        <button class="category-tab" data-idea-category="business">üíº Business</button>
        <button class="category-tab" data-idea-category="feature">‚öôÔ∏è Feature</button>
        <button class="category-tab" data-idea-category="other">üìå Other</button>
      </div>

      <div class="ideas-board">
        <div class="idea-column new" data-idea-status="new">
          <div class="column-header">
            <h2>üí° New Ideas</h2>
            <span class="count">0</span>
          </div>
          <div class="idea-list"></div>
          <button class="add-task-btn" onclick="openIdeaModal()">+ Capture an idea</button>
        </div>

        <div class="idea-column exploring" data-idea-status="exploring">
          <div class="column-header">
            <h2>üîç Exploring</h2>
            <span class="count">0</span>
          </div>
          <div class="idea-list"></div>
        </div>

        <div class="idea-column planned" data-idea-status="planned">
          <div class="column-header">
            <h2>üìÖ Planned</h2>
            <span class="count">0</span>
          </div>
          <div class="idea-list"></div>
        </div>
      </div>

      <div class="archive-toggle">
        <button onclick="toggleArchivedIdeas()">üì¶ Show Archived Ideas</button>
      </div>

      <div class="archived-ideas" id="archived-ideas">
        <h3>üì¶ Archived Ideas</h3>
        <div class="archived-idea-list"></div>
      </div>

      <!-- Ideas Stats -->
      <div class="stats" style="margin-top: 40px;">
        <div class="stat-card">
          <div class="stat-icon">üí°</div>
          <div class="stat-value" id="total-ideas">0</div>
          <div class="stat-label">Total Ideas</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üîç</div>
          <div class="stat-value" id="exploring-ideas">0</div>
          <div class="stat-label">Exploring</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-value" id="planned-ideas">0</div>
          <div class="stat-label">Planned</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üì¶</div>
          <div class="stat-value" id="archived-ideas-count">0</div>
          <div class="stat-label">Archived</div>
        </div>
      </div>

    </div><!-- End Ideas View -->

    <!-- Notes View -->
    <div id="notes-view" class="view-container">
      
      <div class="notes-filters">
        <button class="category-tab active" data-note-project="all">üìù All Notes</button>
        <button class="category-tab" data-note-project="KLASS">üü£ KLASS</button>
        <button class="category-tab" data-note-project="TouchGrass">üü¢ TouchGrass</button>
        <button class="category-tab" data-note-project="Timeslot">üü† Timeslot</button>
        <button class="category-tab" data-note-project="general">‚ö™ General</button>
      </div>

      <div class="notes-filters">
        <button class="category-tab active" data-note-type="all">üè∑Ô∏è All Types</button>
        <button class="category-tab" data-note-type="note">üìù Note</button>
        <button class="category-tab" data-note-type="decision">‚öñÔ∏è Decision</button>
        <button class="category-tab" data-note-type="learning">üéì Learning</button>
        <button class="category-tab" data-note-type="research">üî¨ Research</button>
        <button class="category-tab" data-note-type="reference">üìö Reference</button>
      </div>

      <button class="add-note-btn" onclick="toggleNoteForm()">+ Capture a note, sir</button>
      
      <div class="add-note-form" id="add-note-form">
        <input type="text" id="note-title-input" placeholder="Note title..." style="margin-bottom:10px;">
        <textarea id="note-content-input" placeholder="Content (optional)..." style="resize:vertical;height:80px;margin-bottom:10px;width:100%;padding:12px;background:var(--bg-hover);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.95rem;"></textarea>
        <div class="form-row">
          <select id="note-project-select">
            <option value="general">‚ö™ General</option>
            <option value="KLASS">üü£ KLASS</option>
            <option value="TouchGrass">üü¢ TouchGrass</option>
            <option value="Timeslot">üü† Timeslot</option>
          </select>
          <select id="note-type-select">
            <option value="note">üìù Note</option>
            <option value="decision">‚öñÔ∏è Decision</option>
            <option value="learning">üéì Learning</option>
            <option value="research">üî¨ Research</option>
            <option value="reference">üìö Reference</option>
          </select>
        </div>
        <div class="form-buttons" style="margin-top:10px;">
          <button class="btn btn-secondary" onclick="toggleNoteForm()">Cancel</button>
          <button class="btn btn-primary" onclick="addNote()">Save Note</button>
        </div>
      </div>

      <div class="notes-list" id="notes-list"></div>

      <!-- Notes Stats -->
      <div class="stats" style="margin-top: 40px;">
        <div class="stat-card">
          <div class="stat-icon">üìù</div>
          <div class="stat-value" id="total-notes">0</div>
          <div class="stat-label">Total Notes</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚öñÔ∏è</div>
          <div class="stat-value" id="decision-notes">0</div>
          <div class="stat-label">Decisions</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üéì</div>
          <div class="stat-value" id="learning-notes">0</div>
          <div class="stat-label">Learnings</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üî¨</div>
          <div class="stat-value" id="research-notes">0</div>
          <div class="stat-label">Research</div>
        </div>
      </div>

    </div><!-- End Notes View -->

    <!-- Pipeline View -->
    <div id="pipeline-view" class="view-container">

      <div class="pipeline-board">
        <div class="pipeline-column status-idea" data-pipeline-status="idea">
          <div class="column-header">
            <h2>üí° Idea</h2>
            <span class="count">0</span>
          </div>
          <div class="pipeline-list"></div>
          <button class="add-task-btn" onclick="togglePipelineForm(this)">+ Add content idea</button>
          <div class="add-pipeline-form">
            <input type="text" class="pipeline-title-input" placeholder="Content title..." style="margin-bottom:10px;width:100%;padding:12px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.95rem;">
            <div class="form-row">
              <select class="pipeline-type-select">
                <option value="blog">üìù Blog Post</option>
                <option value="video">üé¨ Video</option>
                <option value="tweet">üê¶ Tweet/Thread</option>
                <option value="newsletter">üìß Newsletter</option>
                <option value="tutorial">üìñ Tutorial</option>
                <option value="podcast">üéôÔ∏è Podcast</option>
                <option value="other">üìå Other</option>
              </select>
              <select class="pipeline-platform-select">
                <option value="twitter">üê¶ Twitter/X</option>
                <option value="youtube">üì∫ YouTube</option>
                <option value="blog">üìù Blog</option>
                <option value="substack">üìß Substack</option>
                <option value="tiktok">üéµ TikTok</option>
                <option value="instagram">üì∏ Instagram</option>
                <option value="linkedin">üíº LinkedIn</option>
                <option value="other">üìå Other</option>
              </select>
            </div>
            <div class="form-row" style="margin-top:10px;">
              <select class="pipeline-project-select">
                <option value="">No Project</option>
                <option value="KLASS">üü£ KLASS</option>
                <option value="TouchGrass">üü¢ TouchGrass</option>
                <option value="Timeslot">üü† Timeslot</option>
                <option value="general">‚ö™ General</option>
              </select>
              <div></div>
            </div>
            <div class="form-buttons" style="margin-top:10px;">
              <button class="btn btn-secondary" onclick="togglePipelineForm(this)">Cancel</button>
              <button class="btn btn-primary" onclick="addPipelineItem(this)">Add Content</button>
            </div>
          </div>
        </div>

        <div class="pipeline-column status-draft" data-pipeline-status="draft">
          <div class="column-header">
            <h2>‚úçÔ∏è Draft</h2>
            <span class="count">0</span>
          </div>
          <div class="pipeline-list"></div>
        </div>

        <div class="pipeline-column status-ready" data-pipeline-status="ready">
          <div class="column-header">
            <h2>üöÄ Ready</h2>
            <span class="count">0</span>
          </div>
          <div class="pipeline-list"></div>
        </div>

        <div class="pipeline-column status-published" data-pipeline-status="published">
          <div class="column-header">
            <h2>‚úÖ Published</h2>
            <span class="count">0</span>
          </div>
          <div class="pipeline-list"></div>
        </div>
      </div>

      <!-- Pipeline Stats -->
      <div class="stats" style="margin-top: 40px;">
        <div class="stat-card">
          <div class="stat-icon">üì§</div>
          <div class="stat-value" id="total-pipeline">0</div>
          <div class="stat-label">Total Content</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úçÔ∏è</div>
          <div class="stat-value" id="draft-pipeline">0</div>
          <div class="stat-label">In Draft</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üöÄ</div>
          <div class="stat-value" id="ready-pipeline">0</div>
          <div class="stat-label">Ready</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-value" id="published-pipeline">0</div>
          <div class="stat-label">Published</div>
        </div>
      </div>

    </div><!-- End Pipeline View -->

    <!-- Today View -->
    <div id="today-view" class="view-container">
      <div class="today-view">
        <div class="today-header">
          <div class="today-date" id="today-date"></div>
          <div class="today-subtitle">Your daily command center, sir</div>
        </div>

        <div class="today-summary">
          <div class="today-stat">
            <div class="today-stat-value" id="today-completed">0</div>
            <div class="today-stat-label">‚úÖ Completed</div>
          </div>
          <div class="today-stat">
            <div class="today-stat-value" id="today-in-progress">0</div>
            <div class="today-stat-label">‚ö° In Progress</div>
          </div>
          <div class="today-stat">
            <div class="today-stat-value" id="today-notes-count">0</div>
            <div class="today-stat-label">üìù Notes</div>
          </div>
          <div class="today-stat">
            <div class="today-stat-value" id="today-ideas-count">0</div>
            <div class="today-stat-label">üí° Ideas</div>
          </div>
          <div class="today-stat">
            <div class="today-stat-value" id="today-content-count">0</div>
            <div class="today-stat-label">üì§ Content</div>
          </div>
        </div>

        <div id="today-sections"></div>
      </div>
    </div><!-- End Today View -->

    <!-- Idea Modal -->
    <div class="modal-overlay" id="idea-modal">
      <div class="modal">
        <div class="modal-header">
          <h2 id="idea-modal-title">üí° New Idea</h2>
          <button class="modal-close" onclick="closeIdeaModal()">√ó</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="idea-id">
          
          <div class="modal-field">
            <label>Title</label>
            <input type="text" id="idea-title-input" placeholder="What's the idea?">
          </div>
          
          <div class="modal-field">
            <label>Description</label>
            <textarea id="idea-description-input" placeholder="Brief description..."></textarea>
          </div>
          
          <div class="modal-field" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label>Category</label>
              <select id="idea-category-input">
                <option value="app">üì± App</option>
                <option value="content">üé¨ Content</option>
                <option value="business">üíº Business</option>
                <option value="feature">‚öôÔ∏è Feature</option>
                <option value="other">üìå Other</option>
              </select>
            </div>
            <div>
              <label>Priority</label>
              <select id="idea-priority-input">
                <option value="low">üü¢ Low</option>
                <option value="medium" selected>üü° Medium</option>
                <option value="high">üî¥ High</option>
              </select>
            </div>
          </div>
          
          <div class="modal-field">
            <label>Notes / Documentation</label>
            <textarea id="idea-notes-input" placeholder="Add detailed notes, research, links, etc..." style="min-height: 200px;"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeIdeaModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveIdea()">Save Idea</button>
        </div>
      </div>
    </div>

    <footer>
      <p>Crafted with reluctant excellence by <a href="#">Geoffrey</a> üé©</p>
      <p style="margin-top: 5px; font-size: 0.8rem;">"One does not simply abandon a task list."</p>
    </footer>
  </div>

  <div class="toast" id="toast">
    <div class="toast-icon">üéâ</div>
    <div class="toast-content">
      <h3>Well Done, Sir!</h3>
      <p id="toast-message">Task completed magnificently.</p>
    </div>
  </div>

  <div class="shortcut-hint" data-tooltip="Keyboard shortcuts work when not typing in a field">
    <kbd>N</kbd> New task &nbsp;|&nbsp; <kbd>R</kbd> Refresh &nbsp;|&nbsp; <kbd>?</kbd> Help
  </div>

  <script>
    // ===== SUPABASE CONFIG =====
    const SUPABASE_URL = 'https://arprmkukemtlhglsqgcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycHJta3VrZW10bGhnbHNxZ2NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMjAwNjAsImV4cCI6MjA4NDg5NjA2MH0.KpfUmYynUjCoT6WTKaqJMFXxV6V1fQ_sBJz8QFxIrjM';
    const SCHEMA = 'geoffrey';

    // ===== SUPABASE CLIENT =====
    const supabase = {
      async fetch(endpoint, options = {}) {
        const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
        const headers = {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Content-Profile': SCHEMA,
          'Accept-Profile': SCHEMA,
          'Prefer': options.prefer || 'return=representation',
          ...options.headers
        };
        
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const text = await response.text();
        return text ? JSON.parse(text) : null;
      },

      async getTasks() { return this.fetch(`tasks?order=created_at.desc`); },
      async createTask(task) { return this.fetch(`tasks`, { method: 'POST', body: JSON.stringify(task) }); },
      async updateTask(id, updates) { return this.fetch(`tasks?id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(updates) }); },
      async deleteTask(id) { return this.fetch(`tasks?id=eq.${id}`, { method: 'DELETE' }); },
      async getSettings(key) { const r = await this.fetch(`settings?key=eq.${key}`); return r?.[0]?.value; },
      async updateSettings(key, value) { return this.fetch(`settings?key=eq.${key}`, { method: 'PATCH', body: JSON.stringify({ value, updated_at: new Date().toISOString() }) }); },
      // Ideas
      async getIdeas() { return this.fetch(`ideas?order=created_at.desc`); },
      async createIdea(idea) { return this.fetch(`ideas`, { method: 'POST', body: JSON.stringify(idea) }); },
      async updateIdea(id, updates) { return this.fetch(`ideas?id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(updates) }); },
      async deleteIdea(id) { return this.fetch(`ideas?id=eq.${id}`, { method: 'DELETE' }); },
      // Notes
      async getNotes() { return this.fetch(`notes?order=created_at.desc`); },
      async createNote(note) { return this.fetch(`notes`, { method: 'POST', body: JSON.stringify(note) }); },
      async updateNote(id, updates) { return this.fetch(`notes?id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(updates) }); },
      async deleteNote(id) { return this.fetch(`notes?id=eq.${id}`, { method: 'DELETE' }); },
      // Content Pipeline
      async getPipeline() { return this.fetch(`content_pipeline?order=created_at.desc`); },
      async createPipelineItem(item) { return this.fetch(`content_pipeline`, { method: 'POST', body: JSON.stringify(item) }); },
      async updatePipelineItem(id, updates) { return this.fetch(`content_pipeline?id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(updates) }); },
      async deletePipelineItem(id) { return this.fetch(`content_pipeline?id=eq.${id}`, { method: 'DELETE' }); }
    };

    // ===== QUOTES =====
    const geoffreyQuotes = [
      "A task delayed is a task that haunts one's afternoon tea.",
      "I've organized Led Zeppelin's tour schedule. Your tasks are... quaint by comparison.",
      "Might I suggest completing that before it becomes tomorrow's regret?",
      "Excellence is not an act, but a habit. I should know ‚Äî I press my own shirts.",
      "The difference between a good day and a great day is a cleared task list.",
      "I once coordinated a dinner for 47 diplomats. Your three tasks seem manageable.",
      "Procrastination is merely tomorrow's chaos wearing today's pajamas.",
      "Ship it, Master Matt. Ship it before doubt sets in.",
      "Might I remind you ‚Äî revenue-generating apps don't build themselves.",
    ];

    const completionQuotes = [
      "Magnificent work, sir. The task has been vanquished.",
      "Another one bites the dust, as Mr. Mercury would say.",
      "Splendid. Your productivity brings a tear to my eye. Almost.",
      "Task completed with aplomb. I expected nothing less.",
      "Well executed. Perhaps there's hope for you yet.",
    ];

    const emptyStateQuotes = {
      'todo': "Nothing pending? Suspicious. Check your ambitions, sir.",
      'in-progress': "Nothing in flight? Either you're done or in denial.",
      'done': "The accomplishment column awaits your contributions."
    };

    // ===== STATE =====
    let tasks = [];
    let ideas = [];
    let streak = 0;
    let lastCompletionDate = null;
    let currentFilter = 'all';
    let currentIdeaFilter = 'all';
    let currentView = 'tasks';
    let draggedTask = null;
    let draggedIdea = null;
    let isOnline = true;
    let selectedTasks = new Set();
    let editingIdeaId = null;
    let notes = [];
    let pipelineItems = [];
    let currentNoteProjectFilter = 'all';
    let currentNoteTypeFilter = 'all';
    let draggedPipelineCard = null;

    // ===== INIT =====
    async function init() {
      document.getElementById('quote-text').textContent = geoffreyQuotes[Math.floor(Math.random() * geoffreyQuotes.length)];
      setupDragAndDrop();
      setupIdeasDragAndDrop();
      setupPipelineDragAndDrop();
      setupKeyboardShortcuts();
      setupCategoryTabs();
      setupIdeaCategoryTabs();
      setupNoteFilterTabs();
      
      try {
        await loadData();
        setConnectionStatus('connected');
      } catch (error) {
        console.error('Supabase error:', error);
        setConnectionStatus('disconnected');
        loadFromLocalStorage();
        loadIdeasFromLocalStorage();
        showToast('‚ö†Ô∏è', 'Offline Mode', 'Using local data. Changes won\'t sync.');
      }
      
      document.getElementById('loading').classList.add('hidden');
      updateNavBadges();
    }

    function setConnectionStatus(status) {
      const el = document.getElementById('connection-status');
      el.className = `connection-status ${status}`;
      el.querySelector('.status-text').textContent = { connected: '‚òÅÔ∏è Synced', disconnected: 'üì¥ Offline', syncing: 'üîÑ Syncing...' }[status];
      isOnline = status === 'connected';
    }

    async function loadData() {
      setConnectionStatus('syncing');
      tasks = await supabase.getTasks() || [];
      const streakData = await supabase.getSettings('streak');
      if (streakData) { streak = streakData.current || 0; lastCompletionDate = streakData.last_completion_date; }
      renderTasks();
      saveToLocalStorage();
      
      // Load ideas (may fail if table doesn't exist yet)
      try {
        ideas = await supabase.getIdeas() || [];
        renderIdeas();
        saveIdeasToLocalStorage();
      } catch (e) {
        console.warn('Ideas table may not exist yet:', e);
        loadIdeasFromLocalStorage();
        renderIdeas();
      }
      
      // Load notes
      try {
        notes = await supabase.getNotes() || [];
        renderNotes();
        localStorage.setItem('geoffrey-notes', JSON.stringify(notes));
      } catch (e) {
        console.warn('Notes table may not exist yet:', e);
        notes = JSON.parse(localStorage.getItem('geoffrey-notes') || '[]');
        renderNotes();
      }

      // Load pipeline
      try {
        pipelineItems = await supabase.getPipeline() || [];
        renderPipeline();
        localStorage.setItem('geoffrey-pipeline', JSON.stringify(pipelineItems));
      } catch (e) {
        console.warn('Pipeline table may not exist yet:', e);
        pipelineItems = JSON.parse(localStorage.getItem('geoffrey-pipeline') || '[]');
        renderPipeline();
      }
    }

    function loadFromLocalStorage() {
      tasks = JSON.parse(localStorage.getItem('geoffrey-tasks-v2') || '[]');
      streak = parseInt(localStorage.getItem('geoffrey-streak') || '0');
      lastCompletionDate = localStorage.getItem('geoffrey-last-completion');
      renderTasks();
    }

    function saveToLocalStorage() {
      localStorage.setItem('geoffrey-tasks-v2', JSON.stringify(tasks));
      localStorage.setItem('geoffrey-streak', streak.toString());
      if (lastCompletionDate) localStorage.setItem('geoffrey-last-completion', lastCompletionDate);
    }

    // ===== RENDERING =====
    function updateCounts() {
      document.querySelectorAll('.column').forEach(col => {
        const status = col.dataset.status;
        col.querySelector('.count').textContent = getFilteredTasks().filter(t => t.status === status).length;
      });
      const total = tasks.length, completed = tasks.filter(t => t.status === 'done').length;
      document.getElementById('total-tasks').textContent = total;
      document.getElementById('completed-tasks').textContent = completed;
      document.getElementById('completion-rate').textContent = total > 0 ? Math.round((completed / total) * 100) + '%' : '0%';
      document.getElementById('streak').textContent = streak;
    }

    function getFilteredTasks() {
      return currentFilter === 'all' ? tasks : tasks.filter(t => t.category === currentFilter);
    }

    function getCategoryEmoji(cat) {
      return { work: 'üíº', hustle: 'üöÄ', personal: 'üßò', urgent: 'üî•' }[cat] || 'üìå';
    }

    function formatDueDate(d) {
      if (!d) return null;
      const due = new Date(d), diff = Math.ceil((due - new Date()) / 86400000);
      if (diff < 0) return { className: 'overdue', text: `${Math.abs(diff)}d overdue` };
      if (diff === 0) return { className: 'soon', text: 'Due today' };
      if (diff === 1) return { className: 'soon', text: 'Due tomorrow' };
      if (diff <= 3) return { className: 'soon', text: `${diff} days left` };
      return { className: '', text: due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) };
    }

    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    function createTaskElement(task) {
      const div = document.createElement('div');
      div.className = 'task' + (task.status === 'done' ? ' completed' : '') + (selectedTasks.has(task.id) ? ' selected' : '');
      div.draggable = true;
      div.dataset.id = task.id;
      
      const dueInfo = formatDueDate(task.due_date);
      const dueHtml = dueInfo ? `<span class="task-due ${dueInfo.className}">üìÖ ${dueInfo.text}</span>` : '';
      const srcIcon = { telegram: 'üí¨', api: 'üîå' }[task.source] || 'üåê';
      const checkboxHtml = task.status === 'done' ? `<input type="checkbox" class="task-checkbox" ${selectedTasks.has(task.id) ? 'checked' : ''} onclick="toggleTaskSelection('${task.id}', this.checked)" title="Select for bulk action">` : '';

      div.innerHTML = `
        ${checkboxHtml}
        <div class="task-category">${getCategoryEmoji(task.category)} ${task.category}</div>
        <div class="task-title">${escapeHtml(task.title)}</div>
        <div class="task-meta">
          ${dueHtml}
          <span class="task-priority priority-${task.priority}">${task.priority}</span>
          <span class="task-source" title="via ${task.source}">${srcIcon}</span>
        </div>
        <div class="task-actions">
          <button onclick="editTask('${task.id}')">‚úèÔ∏è</button>
          <button onclick="moveTask('${task.id}', 'prev')">‚óÄÔ∏è</button>
          <button onclick="moveTask('${task.id}', 'next')">‚ñ∂Ô∏è</button>
          <button class="delete" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
        </div>
      `;

      div.addEventListener('dragstart', e => { draggedTask = e.target; e.target.classList.add('dragging'); });
      div.addEventListener('dragend', e => { e.target.classList.remove('dragging'); document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over')); draggedTask = null; });

      return div;
    }

    function renderTasks() {
      const filtered = getFilteredTasks();
      document.querySelectorAll('.task-list').forEach(list => {
        const status = list.closest('.column').dataset.status;
        const statusTasks = filtered.filter(t => t.status === status);
        list.innerHTML = statusTasks.length === 0 
          ? `<div class="empty-state"><div class="icon">${status === 'done' ? 'üèÜ' : 'üì≠'}</div><p>${emptyStateQuotes[status]}</p></div>`
          : '';
        statusTasks.forEach(t => list.appendChild(createTaskElement(t)));
      });
      updateCounts();
      updateBulkActionsUI();
    }

    // ===== BULK ACTIONS =====
    function toggleTaskSelection(id, isSelected) {
      if (isSelected) {
        selectedTasks.add(id);
      } else {
        selectedTasks.delete(id);
      }
      updateBulkActionsUI();
      // Update visual state without full re-render
      const taskEl = document.querySelector(`.task[data-id="${id}"]`);
      if (taskEl) taskEl.classList.toggle('selected', isSelected);
    }

    function toggleSelectAll(isSelected) {
      const doneTasks = getFilteredTasks().filter(t => t.status === 'done');
      if (isSelected) {
        doneTasks.forEach(t => selectedTasks.add(t.id));
      } else {
        doneTasks.forEach(t => selectedTasks.delete(t.id));
      }
      renderTasks();
    }

    function updateBulkActionsUI() {
      const doneTasks = getFilteredTasks().filter(t => t.status === 'done');
      const bulkActions = document.getElementById('bulk-actions');
      const clearBtn = document.getElementById('clear-completed');
      const selectAllCheckbox = document.getElementById('select-all-done');
      const selectedCountEl = document.getElementById('selected-count');
      
      // Filter selectedTasks to only include done tasks
      const validSelected = [...selectedTasks].filter(id => doneTasks.some(t => t.id === id));
      selectedTasks = new Set(validSelected);
      
      // Update UI
      selectedCountEl.textContent = selectedTasks.size;
      bulkActions.classList.toggle('active', selectedTasks.size > 0);
      clearBtn.classList.toggle('visible', doneTasks.length > 0);
      
      // Update select all checkbox state
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = doneTasks.length > 0 && selectedTasks.size === doneTasks.length;
        selectAllCheckbox.indeterminate = selectedTasks.size > 0 && selectedTasks.size < doneTasks.length;
      }
    }

    async function bulkDeleteSelected() {
      if (selectedTasks.size === 0) return;
      const count = selectedTasks.size;
      if (!confirm(`Delete ${count} completed task${count > 1 ? 's' : ''}? This cannot be undone.`)) return;
      
      try {
        const idsToDelete = [...selectedTasks];
        for (const id of idsToDelete) {
          if (isOnline && !id.startsWith('local-')) await supabase.deleteTask(id);
        }
        tasks = tasks.filter(t => !selectedTasks.has(t.id));
        selectedTasks.clear();
        saveToLocalStorage();
        renderTasks();
        showToast('üóëÔ∏è', 'Tasks Deleted', `${count} task${count > 1 ? 's' : ''} removed. The clutter has been addressed.`);
      } catch (e) {
        console.error(e);
        showToast('‚ùå', 'Error', 'Failed to delete some tasks.');
      }
    }

    async function clearAllCompleted() {
      const doneTasks = getFilteredTasks().filter(t => t.status === 'done');
      if (doneTasks.length === 0) return;
      if (!confirm(`Clear all ${doneTasks.length} completed task${doneTasks.length > 1 ? 's' : ''}? This cannot be undone.`)) return;
      
      try {
        for (const task of doneTasks) {
          if (isOnline && !task.id.startsWith('local-')) await supabase.deleteTask(task.id);
        }
        const doneIds = new Set(doneTasks.map(t => t.id));
        tasks = tasks.filter(t => !doneIds.has(t.id));
        selectedTasks.clear();
        saveToLocalStorage();
        renderTasks();
        showToast('üßπ', 'All Cleared', `${doneTasks.length} completed task${doneTasks.length > 1 ? 's' : ''} swept away. A fresh slate, sir.`);
      } catch (e) {
        console.error(e);
        showToast('‚ùå', 'Error', 'Failed to clear completed tasks.');
      }
    }

    // ===== TASK OPS =====
    function toggleForm(btn) {
      const col = btn.closest('.column'), form = col.querySelector('.add-task-form'), addBtn = col.querySelector('.add-task-btn');
      form.classList.toggle('active');
      addBtn.style.display = form.classList.contains('active') ? 'none' : 'block';
      if (form.classList.contains('active')) form.querySelector('.task-input').focus();
    }

    async function addTask(btn) {
      const form = btn.closest('.add-task-form');
      const title = form.querySelector('.task-input').value.trim();
      if (!title) return;
      
      const dueDate = form.querySelector('.due-date').value;
      const dueTime = form.querySelector('.due-time').value;
      const task = {
        title,
        category: form.querySelector('.category-select').value,
        priority: form.querySelector('.priority-select').value,
        status: 'todo',
        due_date: dueDate ? (dueTime ? `${dueDate}T${dueTime}:00` : `${dueDate}T23:59:59`) : null,
        source: 'web'
      };

      btn.disabled = true;
      try {
        if (isOnline) {
          const [created] = await supabase.createTask(task);
          tasks.unshift(created);
        } else {
          task.id = 'local-' + Date.now();
          task.created_at = new Date().toISOString();
          tasks.unshift(task);
        }
        saveToLocalStorage();
        renderTasks();
        form.querySelector('.task-input').value = '';
        form.querySelector('.due-date').value = '';
        form.querySelector('.due-time').value = '';
        toggleForm(btn);
        showToast('üìù', 'Task Added', 'I shall keep a watchful eye on this one.');
      } catch (e) { console.error(e); showToast('‚ùå', 'Error', 'Failed to save task.'); }
      btn.disabled = false;
    }

    async function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        if (isOnline && !id.startsWith('local-')) await supabase.deleteTask(id);
        tasks = tasks.filter(t => t.id !== id);
        saveToLocalStorage();
        renderTasks();
      } catch (e) { showToast('‚ùå', 'Error', 'Failed to delete.'); }
    }

    async function editTask(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      const newTitle = prompt('Edit task:', task.title);
      if (newTitle?.trim()) {
        try {
          if (isOnline && !id.startsWith('local-')) await supabase.updateTask(id, { title: newTitle.trim() });
          task.title = newTitle.trim();
          saveToLocalStorage();
          renderTasks();
        } catch (e) { showToast('‚ùå', 'Error', 'Failed to update.'); }
      }
    }

    async function moveTask(id, dir) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      const statuses = ['todo', 'in-progress', 'done'];
      const idx = statuses.indexOf(task.status);
      const newStatus = dir === 'next' && idx < 2 ? statuses[idx + 1] : dir === 'prev' && idx > 0 ? statuses[idx - 1] : task.status;
      if (newStatus !== task.status) await updateTaskStatus(task, newStatus);
    }

    async function updateTaskStatus(task, newStatus) {
      const wasDone = task.status === 'done';
      try {
        const updates = { status: newStatus, completed_at: newStatus === 'done' ? new Date().toISOString() : null };
        if (isOnline && !task.id.startsWith('local-')) await supabase.updateTask(task.id, updates);
        task.status = newStatus;
        task.completed_at = updates.completed_at;
        if (newStatus === 'done' && !wasDone) await celebrateCompletion();
        saveToLocalStorage();
        renderTasks();
      } catch (e) { showToast('‚ùå', 'Error', 'Failed to update.'); }
    }

    async function celebrateCompletion() {
      const today = new Date().toDateString(), yesterday = new Date(Date.now() - 86400000).toDateString();
      if (lastCompletionDate !== today) {
        streak = lastCompletionDate === yesterday ? streak + 1 : 1;
        lastCompletionDate = today;
        if (isOnline) try { await supabase.updateSettings('streak', { current: streak, last_completion_date: today }); } catch (e) {}
        saveToLocalStorage();
      }
      showToast('üéâ', 'Task Complete!', completionQuotes[Math.floor(Math.random() * completionQuotes.length)]);
      createConfetti();
    }

    // ===== UI =====
    function showToast(icon, title, msg) {
      const t = document.getElementById('toast');
      t.querySelector('.toast-icon').textContent = icon;
      t.querySelector('h3').textContent = title;
      t.querySelector('#toast-message').textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 4000);
    }

    function createConfetti() {
      const colors = ['#d4af37', '#f4d03f', '#aa8c2c', '#fff', '#3fb950'];
      for (let i = 0; i < 50; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.cssText = `left:${Math.random()*100}vw;top:-10px;background:${colors[Math.floor(Math.random()*colors.length)]};border-radius:${Math.random()>.5?'50%':'0'}`;
        document.body.appendChild(c);
        c.animate([
          { transform: 'translateY(0) rotate(0)', opacity: 1 },
          { transform: `translateY(100vh) rotate(${Math.random()*720}deg)`, opacity: 0 }
        ], { duration: 2000 + Math.random() * 2000, easing: 'ease-out' }).onfinish = () => c.remove();
      }
    }

    // ===== DRAG & DROP =====
    function setupDragAndDrop() {
      document.querySelectorAll('.column').forEach(col => {
        col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drag-over'); });
        col.addEventListener('dragleave', e => { if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over'); });
        col.addEventListener('drop', async e => {
          e.preventDefault();
          col.classList.remove('drag-over');
          if (draggedTask) {
            const task = tasks.find(t => t.id === draggedTask.dataset.id);
            if (task && task.status !== col.dataset.status) await updateTaskStatus(task, col.dataset.status);
          }
        });
      });
    }

    // ===== TABS & KEYBOARD =====
    function setupCategoryTabs() {
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.category;
          renderTasks();
        });
      });
    }

    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (e.key === 'n' || e.key === 'N') {
          if (currentView === 'tasks') {
            const btn = document.querySelector('.column.todo .add-task-btn');
            if (!document.querySelector('.column.todo .add-task-form').classList.contains('active')) toggleForm(btn);
          } else {
            openIdeaModal();
          }
        }
        if (e.key === 'r' || e.key === 'R') loadData().catch(() => loadFromLocalStorage());
        if (e.key === 'Escape') closeIdeaModal();
      });
      document.querySelectorAll('.task-input').forEach(input => {
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addTask(input.closest('.add-task-form').querySelector('.btn-primary')); }
        });
      });
    }

    // ===== VIEW SWITCHING =====
    function switchView(view) {
      currentView = view;
      document.querySelectorAll('.main-nav-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
      document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
      document.getElementById(`${view}-view`).classList.add('active');
      if (view === 'today') renderToday();
    }

    // ===== IDEAS FUNCTIONS =====
    const ideaCategoryEmojis = { app: 'üì±', content: 'üé¨', business: 'üíº', feature: '‚öôÔ∏è', other: 'üìå' };

    function getFilteredIdeas() {
      const nonArchived = ideas.filter(i => i.status !== 'archived');
      return currentIdeaFilter === 'all' ? nonArchived : nonArchived.filter(i => i.category === currentIdeaFilter);
    }

    function getArchivedIdeas() {
      return ideas.filter(i => i.status === 'archived');
    }

    function createIdeaElement(idea) {
      const div = document.createElement('div');
      div.className = `idea status-${idea.status}` + (idea.status === 'archived' ? ' archived-idea' : '');
      div.dataset.id = idea.id;
      div.draggable = true;

      const hasNotes = idea.notes && idea.notes.trim().length > 0;
      const notesIndicator = hasNotes ? `<span class="idea-has-notes">üìù Has notes</span>` : '';

      div.innerHTML = `
        <div class="idea-category">${ideaCategoryEmojis[idea.category] || 'üìå'} ${idea.category}</div>
        <div class="idea-title">${escapeHtml(idea.title)}</div>
        ${idea.description ? `<div class="idea-description">${escapeHtml(idea.description)}</div>` : ''}
        <div class="idea-meta">
          ${notesIndicator}
          <span class="task-priority priority-${idea.priority}">${idea.priority}</span>
        </div>
        <div class="idea-actions">
          <button onclick="openIdeaModal('${idea.id}')">‚úèÔ∏è Edit</button>
          <button onclick="moveIdea('${idea.id}', 'prev')">‚óÄÔ∏è</button>
          <button onclick="moveIdea('${idea.id}', 'next')">‚ñ∂Ô∏è</button>
          ${idea.status !== 'archived' ? `<button onclick="archiveIdea('${idea.id}')">üì¶</button>` : `<button onclick="restoreIdea('${idea.id}')">‚ôªÔ∏è</button>`}
          <button class="delete" onclick="deleteIdea('${idea.id}')">üóëÔ∏è</button>
        </div>
      `;

      div.addEventListener('click', e => {
        if (!e.target.closest('.idea-actions')) openIdeaModal(idea.id);
      });

      div.addEventListener('dragstart', e => { draggedIdea = e.target; e.target.classList.add('dragging'); });
      div.addEventListener('dragend', e => { e.target.classList.remove('dragging'); document.querySelectorAll('.idea-column').forEach(c => c.classList.remove('drag-over')); draggedIdea = null; });

      return div;
    }

    function renderIdeas() {
      const filtered = getFilteredIdeas();
      
      document.querySelectorAll('.idea-column').forEach(col => {
        const status = col.dataset.ideaStatus;
        const list = col.querySelector('.idea-list');
        const statusIdeas = filtered.filter(i => i.status === status);
        
        col.querySelector('.count').textContent = statusIdeas.length;
        list.innerHTML = statusIdeas.length === 0 
          ? `<div class="empty-state"><div class="icon">üí≠</div><p>No ideas here yet</p></div>`
          : '';
        statusIdeas.forEach(i => list.appendChild(createIdeaElement(i)));
      });

      // Render archived
      const archived = getArchivedIdeas();
      const archivedList = document.querySelector('.archived-idea-list');
      archivedList.innerHTML = archived.length === 0 
        ? `<div class="empty-state"><p>No archived ideas</p></div>`
        : '';
      archived.forEach(i => archivedList.appendChild(createIdeaElement(i)));

      updateIdeasStats();
      updateNavBadges();
    }

    function updateIdeasStats() {
      const active = ideas.filter(i => i.status !== 'archived');
      document.getElementById('total-ideas').textContent = active.length;
      document.getElementById('exploring-ideas').textContent = ideas.filter(i => i.status === 'exploring').length;
      document.getElementById('planned-ideas').textContent = ideas.filter(i => i.status === 'planned').length;
      document.getElementById('archived-ideas-count').textContent = ideas.filter(i => i.status === 'archived').length;
    }

    function updateNavBadges() {
      document.getElementById('tasks-badge').textContent = tasks.filter(t => t.status !== 'done').length;
      document.getElementById('ideas-badge').textContent = ideas.filter(i => i.status !== 'archived').length;
      document.getElementById('notes-badge').textContent = notes.length;
      document.getElementById('pipeline-badge').textContent = pipelineItems.filter(p => p.status !== 'published').length;
    }

    function openIdeaModal(id = null) {
      editingIdeaId = id;
      const modal = document.getElementById('idea-modal');
      const title = document.getElementById('idea-modal-title');
      
      if (id) {
        const idea = ideas.find(i => i.id === id);
        if (!idea) return;
        title.textContent = '‚úèÔ∏è Edit Idea';
        document.getElementById('idea-id').value = id;
        document.getElementById('idea-title-input').value = idea.title || '';
        document.getElementById('idea-description-input').value = idea.description || '';
        document.getElementById('idea-category-input').value = idea.category || 'app';
        document.getElementById('idea-priority-input').value = idea.priority || 'medium';
        document.getElementById('idea-notes-input').value = idea.notes || '';
      } else {
        title.textContent = 'üí° New Idea';
        document.getElementById('idea-id').value = '';
        document.getElementById('idea-title-input').value = '';
        document.getElementById('idea-description-input').value = '';
        document.getElementById('idea-category-input').value = 'app';
        document.getElementById('idea-priority-input').value = 'medium';
        document.getElementById('idea-notes-input').value = '';
      }
      
      modal.classList.add('active');
      document.getElementById('idea-title-input').focus();
    }

    function closeIdeaModal() {
      document.getElementById('idea-modal').classList.remove('active');
      editingIdeaId = null;
    }

    async function saveIdea() {
      const id = document.getElementById('idea-id').value;
      const ideaData = {
        title: document.getElementById('idea-title-input').value.trim(),
        description: document.getElementById('idea-description-input').value.trim(),
        category: document.getElementById('idea-category-input').value,
        priority: document.getElementById('idea-priority-input').value,
        notes: document.getElementById('idea-notes-input').value.trim()
      };

      if (!ideaData.title) {
        showToast('‚ö†Ô∏è', 'Missing Title', 'Every idea needs at least a title, sir.');
        return;
      }

      try {
        if (id) {
          // Update existing
          if (isOnline) await supabase.updateIdea(id, ideaData);
          const idx = ideas.findIndex(i => i.id === id);
          if (idx !== -1) ideas[idx] = { ...ideas[idx], ...ideaData };
          showToast('‚úèÔ∏è', 'Idea Updated', 'Your idea has been refined.');
        } else {
          // Create new
          ideaData.status = 'new';
          ideaData.source = 'web';
          if (isOnline) {
            const [created] = await supabase.createIdea(ideaData);
            ideas.unshift(created);
          } else {
            ideaData.id = 'local-' + Date.now();
            ideaData.created_at = new Date().toISOString();
            ideas.unshift(ideaData);
          }
          showToast('üí°', 'Idea Captured', 'Another spark of brilliance preserved.');
        }
        
        saveIdeasToLocalStorage();
        renderIdeas();
        closeIdeaModal();
      } catch (e) {
        console.error(e);
        showToast('‚ùå', 'Error', 'Failed to save idea.');
      }
    }

    async function moveIdea(id, dir) {
      const idea = ideas.find(i => i.id === id);
      if (!idea) return;
      
      const statuses = ['new', 'exploring', 'planned'];
      const idx = statuses.indexOf(idea.status);
      let newStatus;
      
      if (dir === 'next' && idx < 2) newStatus = statuses[idx + 1];
      else if (dir === 'prev' && idx > 0) newStatus = statuses[idx - 1];
      else return;

      try {
        if (isOnline && !idea.id.startsWith('local-')) await supabase.updateIdea(id, { status: newStatus });
        idea.status = newStatus;
        saveIdeasToLocalStorage();
        renderIdeas();
        showToast('‚û°Ô∏è', 'Idea Moved', `Moved to ${newStatus}.`);
      } catch (e) {
        showToast('‚ùå', 'Error', 'Failed to move idea.');
      }
    }

    async function archiveIdea(id) {
      const idea = ideas.find(i => i.id === id);
      if (!idea) return;
      
      try {
        const updates = { status: 'archived', archived_at: new Date().toISOString() };
        if (isOnline && !idea.id.startsWith('local-')) await supabase.updateIdea(id, updates);
        idea.status = 'archived';
        idea.archived_at = updates.archived_at;
        saveIdeasToLocalStorage();
        renderIdeas();
        showToast('üì¶', 'Idea Archived', 'Safely stored for later consideration.');
      } catch (e) {
        showToast('‚ùå', 'Error', 'Failed to archive idea.');
      }
    }

    async function restoreIdea(id) {
      const idea = ideas.find(i => i.id === id);
      if (!idea) return;
      
      try {
        if (isOnline && !idea.id.startsWith('local-')) await supabase.updateIdea(id, { status: 'new', archived_at: null });
        idea.status = 'new';
        idea.archived_at = null;
        saveIdeasToLocalStorage();
        renderIdeas();
        showToast('‚ôªÔ∏è', 'Idea Restored', 'Back in the pipeline.');
      } catch (e) {
        showToast('‚ùå', 'Error', 'Failed to restore idea.');
      }
    }

    async function deleteIdea(id) {
      if (!confirm('Permanently delete this idea?')) return;
      
      try {
        if (isOnline && !id.startsWith('local-')) await supabase.deleteIdea(id);
        ideas = ideas.filter(i => i.id !== id);
        saveIdeasToLocalStorage();
        renderIdeas();
        showToast('üóëÔ∏è', 'Idea Deleted', 'Gone forever.');
      } catch (e) {
        showToast('‚ùå', 'Error', 'Failed to delete idea.');
      }
    }

    function toggleArchivedIdeas() {
      const el = document.getElementById('archived-ideas');
      el.classList.toggle('visible');
    }

    function saveIdeasToLocalStorage() {
      localStorage.setItem('geoffrey-ideas', JSON.stringify(ideas));
    }

    function loadIdeasFromLocalStorage() {
      ideas = JSON.parse(localStorage.getItem('geoffrey-ideas') || '[]');
    }

    // Setup Ideas drag and drop
    function setupIdeasDragAndDrop() {
      document.querySelectorAll('.idea-column').forEach(col => {
        col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drag-over'); });
        col.addEventListener('dragleave', e => { if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over'); });
        col.addEventListener('drop', async e => {
          e.preventDefault();
          col.classList.remove('drag-over');
          if (draggedIdea) {
            const idea = ideas.find(i => i.id === draggedIdea.dataset.id);
            if (idea && idea.status !== col.dataset.ideaStatus) {
              try {
                if (isOnline && !idea.id.startsWith('local-')) await supabase.updateIdea(idea.id, { status: col.dataset.ideaStatus });
                idea.status = col.dataset.ideaStatus;
                saveIdeasToLocalStorage();
                renderIdeas();
              } catch (e) {
                showToast('‚ùå', 'Error', 'Failed to move idea.');
              }
            }
          }
        });
      });
    }

    // Setup Ideas category tabs
    function setupIdeaCategoryTabs() {
      document.querySelectorAll('.idea-category-tabs .category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.idea-category-tabs .category-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentIdeaFilter = tab.dataset.ideaCategory;
          renderIdeas();
        });
      });
    }

    // ===== NOTES FUNCTIONS =====
    const noteTypeEmojis = { note: 'üìù', decision: '‚öñÔ∏è', learning: 'üéì', research: 'üî¨', reference: 'üìö' };
    const projectEmojis = { KLASS: 'üü£', TouchGrass: 'üü¢', Timeslot: 'üü†', general: '‚ö™' };

    function setupNoteFilterTabs() {
      document.querySelectorAll('[data-note-project]').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('[data-note-project]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentNoteProjectFilter = tab.dataset.noteProject;
          renderNotes();
        });
      });
      document.querySelectorAll('[data-note-type]').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('[data-note-type]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentNoteTypeFilter = tab.dataset.noteType;
          renderNotes();
        });
      });
    }

    function getFilteredNotes() {
      let filtered = notes;
      if (currentNoteProjectFilter !== 'all') filtered = filtered.filter(n => n.project === currentNoteProjectFilter);
      if (currentNoteTypeFilter !== 'all') filtered = filtered.filter(n => n.type === currentNoteTypeFilter);
      return filtered;
    }

    function toggleNoteForm() {
      const form = document.getElementById('add-note-form');
      form.classList.toggle('active');
      if (form.classList.contains('active')) document.getElementById('note-title-input').focus();
    }

    function createNoteElement(note) {
      const div = document.createElement('div');
      div.className = 'note-card';
      div.dataset.id = note.id;

      const projectClass = note.project ? `project-${note.project.toLowerCase()}` : 'project-general';
      const projectLabel = note.project || 'general';
      const typeLabel = note.type || 'note';
      const timeAgo = getTimeAgo(note.created_at);
      const contentPreview = note.content ? `<div class="note-content-preview">${escapeHtml(note.content)}</div>` : '';

      div.innerHTML = `
        <div class="note-header">
          <div class="note-title">${escapeHtml(note.title)}</div>
          <div class="note-badges">
            <span class="badge-pill badge-project ${projectClass}">${projectEmojis[projectLabel] || '‚ö™'} ${projectLabel}</span>
            <span class="badge-pill badge-type">${noteTypeEmojis[typeLabel] || 'üìù'} ${typeLabel}</span>
          </div>
        </div>
        ${contentPreview}
        <div class="note-meta">
          <span>${timeAgo}</span>
          <div class="note-actions">
            <button onclick="editNote('${note.id}')">‚úèÔ∏è Edit</button>
            <button class="delete" onclick="deleteNote('${note.id}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `;
      return div;
    }

    function getTimeAgo(dateStr) {
      if (!dateStr) return '';
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'Just now';
      if (mins < 60) return `${mins}m ago`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function renderNotes() {
      const filtered = getFilteredNotes();
      const list = document.getElementById('notes-list');
      
      if (filtered.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="icon">üìù</div><p>No notes yet. Capture your first thought, sir.</p></div>`;
      } else {
        list.innerHTML = '';
        filtered.forEach(n => list.appendChild(createNoteElement(n)));
      }

      // Update stats
      document.getElementById('total-notes').textContent = notes.length;
      document.getElementById('decision-notes').textContent = notes.filter(n => n.type === 'decision').length;
      document.getElementById('learning-notes').textContent = notes.filter(n => n.type === 'learning').length;
      document.getElementById('research-notes').textContent = notes.filter(n => n.type === 'research').length;
      updateNavBadges();
    }

    async function addNote() {
      const title = document.getElementById('note-title-input').value.trim();
      if (!title) { showToast('‚ö†Ô∏è', 'Missing Title', 'Every note needs a title, sir.'); return; }
      
      const noteData = {
        title,
        content: document.getElementById('note-content-input').value.trim(),
        project: document.getElementById('note-project-select').value,
        type: document.getElementById('note-type-select').value,
        source: 'web'
      };

      try {
        if (isOnline) {
          const [created] = await supabase.createNote(noteData);
          notes.unshift(created);
        } else {
          noteData.id = 'local-' + Date.now();
          noteData.created_at = new Date().toISOString();
          notes.unshift(noteData);
        }
        localStorage.setItem('geoffrey-notes', JSON.stringify(notes));
        renderNotes();
        document.getElementById('note-title-input').value = '';
        document.getElementById('note-content-input').value = '';
        toggleNoteForm();
        showToast('üìù', 'Note Captured', 'Your thought has been preserved for posterity.');
      } catch (e) {
        console.error(e);
        showToast('‚ùå', 'Error', 'Failed to save note.');
      }
    }

    async function editNote(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;
      const newTitle = prompt('Edit note title:', note.title);
      if (newTitle?.trim()) {
        try {
          if (isOnline && !id.startsWith('local-')) await supabase.updateNote(id, { title: newTitle.trim() });
          note.title = newTitle.trim();
          localStorage.setItem('geoffrey-notes', JSON.stringify(notes));
          renderNotes();
        } catch (e) { showToast('‚ùå', 'Error', 'Failed to update note.'); }
      }
    }

    async function deleteNote(id) {
      if (!confirm('Delete this note?')) return;
      try {
        if (isOnline && !id.startsWith('local-')) await supabase.deleteNote(id);
        notes = notes.filter(n => n.id !== id);
        localStorage.setItem('geoffrey-notes', JSON.stringify(notes));
        renderNotes();
        showToast('üóëÔ∏è', 'Note Deleted', 'Gone, but the wisdom remains.');
      } catch (e) { showToast('‚ùå', 'Error', 'Failed to delete note.'); }
    }

    // ===== PIPELINE FUNCTIONS =====
    const contentTypeEmojis = { blog: 'üìù', video: 'üé¨', tweet: 'üê¶', newsletter: 'üìß', tutorial: 'üìñ', podcast: 'üéôÔ∏è', other: 'üìå' };
    const platformEmojis = { twitter: 'üê¶', youtube: 'üì∫', blog: 'üìù', substack: 'üìß', tiktok: 'üéµ', instagram: 'üì∏', linkedin: 'üíº', other: 'üìå' };
    const pipelineStatuses = ['idea', 'draft', 'ready', 'published'];

    function togglePipelineForm(btn) {
      const col = btn.closest('.pipeline-column');
      const form = col.querySelector('.add-pipeline-form');
      const addBtn = col.querySelector('.add-task-btn');
      form.classList.toggle('active');
      addBtn.style.display = form.classList.contains('active') ? 'none' : 'block';
      if (form.classList.contains('active')) form.querySelector('.pipeline-title-input').focus();
    }

    function createPipelineElement(item) {
      const div = document.createElement('div');
      div.className = 'pipeline-card';
      div.draggable = true;
      div.dataset.id = item.id;

      const typeEmoji = contentTypeEmojis[item.content_type] || 'üìå';
      const platformEmoji = platformEmojis[item.platform] || 'üìå';
      const projectHtml = item.project ? `<span class="pipeline-card-project">${projectEmojis[item.project] || '‚ö™'} ${item.project}</span>` : '';

      div.innerHTML = `
        <div class="pipeline-card-type">${typeEmoji} ${item.content_type || 'content'}</div>
        <div class="pipeline-card-title">${escapeHtml(item.title)}</div>
        <div class="pipeline-card-meta">
          <span class="pipeline-card-platform">${platformEmoji} ${item.platform || 'unset'}</span>
          ${projectHtml}
        </div>
        <div class="pipeline-card-actions">
          <button onclick="movePipeline('${item.id}', 'prev')">‚óÄÔ∏è</button>
          <button onclick="movePipeline('${item.id}', 'next')">‚ñ∂Ô∏è</button>
          <button class="delete" onclick="deletePipelineItem('${item.id}')">üóëÔ∏è</button>
        </div>
      `;

      div.addEventListener('dragstart', e => { draggedPipelineCard = e.target; e.target.classList.add('dragging'); });
      div.addEventListener('dragend', e => { e.target.classList.remove('dragging'); document.querySelectorAll('.pipeline-column').forEach(c => c.classList.remove('drag-over')); draggedPipelineCard = null; });

      return div;
    }

    function renderPipeline() {
      document.querySelectorAll('.pipeline-column').forEach(col => {
        const status = col.dataset.pipelineStatus;
        const list = col.querySelector('.pipeline-list');
        const items = pipelineItems.filter(p => p.status === status);
        
        col.querySelector('.count').textContent = items.length;
        if (items.length === 0) {
          list.innerHTML = `<div class="empty-state"><div class="icon">üì≠</div><p>Nothing here yet</p></div>`;
        } else {
          list.innerHTML = '';
          items.forEach(item => list.appendChild(createPipelineElement(item)));
        }
      });

      // Update stats
      document.getElementById('total-pipeline').textContent = pipelineItems.length;
      document.getElementById('draft-pipeline').textContent = pipelineItems.filter(p => p.status === 'draft').length;
      document.getElementById('ready-pipeline').textContent = pipelineItems.filter(p => p.status === 'ready').length;
      document.getElementById('published-pipeline').textContent = pipelineItems.filter(p => p.status === 'published').length;
      updateNavBadges();
    }

    async function addPipelineItem(btn) {
      const form = btn.closest('.add-pipeline-form');
      const title = form.querySelector('.pipeline-title-input').value.trim();
      if (!title) { showToast('‚ö†Ô∏è', 'Missing Title', 'Content needs a title, sir.'); return; }

      const item = {
        title,
        content_type: form.querySelector('.pipeline-type-select').value,
        platform: form.querySelector('.pipeline-platform-select').value,
        project: form.querySelector('.pipeline-project-select').value || null,
        status: 'idea',
        source: 'web'
      };

      btn.disabled = true;
      try {
        if (isOnline) {
          const [created] = await supabase.createPipelineItem(item);
          pipelineItems.unshift(created);
        } else {
          item.id = 'local-' + Date.now();
          item.created_at = new Date().toISOString();
          pipelineItems.unshift(item);
        }
        localStorage.setItem('geoffrey-pipeline', JSON.stringify(pipelineItems));
        renderPipeline();
        form.querySelector('.pipeline-title-input').value = '';
        togglePipelineForm(btn);
        showToast('üì§', 'Content Added', 'Into the pipeline it goes.');
      } catch (e) {
        console.error(e);
        showToast('‚ùå', 'Error', 'Failed to save content item.');
      }
      btn.disabled = false;
    }

    async function movePipeline(id, dir) {
      const item = pipelineItems.find(p => p.id === id);
      if (!item) return;
      const idx = pipelineStatuses.indexOf(item.status);
      let newStatus;
      if (dir === 'next' && idx < pipelineStatuses.length - 1) newStatus = pipelineStatuses[idx + 1];
      else if (dir === 'prev' && idx > 0) newStatus = pipelineStatuses[idx - 1];
      else return;

      try {
        const updates = { status: newStatus };
        if (newStatus === 'published') updates.published_at = new Date().toISOString();
        if (isOnline && !item.id.startsWith('local-')) await supabase.updatePipelineItem(id, updates);
        item.status = newStatus;
        if (updates.published_at) item.published_at = updates.published_at;
        localStorage.setItem('geoffrey-pipeline', JSON.stringify(pipelineItems));
        renderPipeline();
        const statusLabels = { idea: 'Idea', draft: 'Draft', ready: 'Ready', published: 'Published' };
        showToast('‚û°Ô∏è', 'Content Moved', `Moved to ${statusLabels[newStatus]}.`);
        if (newStatus === 'published') createConfetti();
      } catch (e) {
        showToast('‚ùå', 'Error', 'Failed to move content.');
      }
    }

    async function deletePipelineItem(id) {
      if (!confirm('Delete this content item?')) return;
      try {
        if (isOnline && !id.startsWith('local-')) await supabase.deletePipelineItem(id);
        pipelineItems = pipelineItems.filter(p => p.id !== id);
        localStorage.setItem('geoffrey-pipeline', JSON.stringify(pipelineItems));
        renderPipeline();
        showToast('üóëÔ∏è', 'Content Deleted', 'Removed from the pipeline.');
      } catch (e) { showToast('‚ùå', 'Error', 'Failed to delete content item.'); }
    }

    function setupPipelineDragAndDrop() {
      document.querySelectorAll('.pipeline-column').forEach(col => {
        col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drag-over'); });
        col.addEventListener('dragleave', e => { if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over'); });
        col.addEventListener('drop', async e => {
          e.preventDefault();
          col.classList.remove('drag-over');
          if (draggedPipelineCard) {
            const item = pipelineItems.find(p => p.id === draggedPipelineCard.dataset.id);
            const newStatus = col.dataset.pipelineStatus;
            if (item && item.status !== newStatus) {
              try {
                const updates = { status: newStatus };
                if (newStatus === 'published') updates.published_at = new Date().toISOString();
                if (isOnline && !item.id.startsWith('local-')) await supabase.updatePipelineItem(item.id, updates);
                item.status = newStatus;
                if (updates.published_at) item.published_at = updates.published_at;
                localStorage.setItem('geoffrey-pipeline', JSON.stringify(pipelineItems));
                renderPipeline();
                if (newStatus === 'published') createConfetti();
              } catch (e) {
                showToast('‚ùå', 'Error', 'Failed to move content.');
              }
            }
          }
        });
      });
    }

    // ===== TODAY VIEW FUNCTIONS =====
    function renderToday() {
      const today = new Date();
      const todayStr = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('today-date').textContent = todayStr;

      const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();

      // Filter items created/completed today
      const completedToday = tasks.filter(t => t.status === 'done' && t.completed_at && t.completed_at >= todayStart);
      const inProgress = tasks.filter(t => t.status === 'in-progress');
      const notesToday = notes.filter(n => n.created_at && n.created_at >= todayStart);
      const ideasToday = ideas.filter(i => i.created_at && i.created_at >= todayStart);
      const contentToday = pipelineItems.filter(p => p.created_at && p.created_at >= todayStart);

      // Update summary stats
      document.getElementById('today-completed').textContent = completedToday.length;
      document.getElementById('today-in-progress').textContent = inProgress.length;
      document.getElementById('today-notes-count').textContent = notesToday.length;
      document.getElementById('today-ideas-count').textContent = ideasToday.length;
      document.getElementById('today-content-count').textContent = contentToday.length;

      // Build sections
      const sectionsContainer = document.getElementById('today-sections');
      sectionsContainer.innerHTML = '';

      // Helper to build a section
      function buildSection(title, emoji, items, renderFn) {
        const section = document.createElement('div');
        section.className = 'today-section';
        section.innerHTML = `
          <div class="today-section-header">
            <h3>${emoji} ${title}</h3>
            <span class="section-count">${items.length}</span>
          </div>
        `;
        if (items.length === 0) {
          section.innerHTML += `<div class="today-empty"><div class="icon">${emoji}</div>Nothing here today... yet.</div>`;
        } else {
          items.forEach(item => {
            section.innerHTML += renderFn(item);
          });
        }
        sectionsContainer.appendChild(section);
      }

      buildSection('Completed Tasks', '‚úÖ', completedToday, task => {
        const time = task.completed_at ? new Date(task.completed_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
        return `<div class="today-item">
          <span class="today-item-icon">‚úÖ</span>
          <span class="today-item-title">${escapeHtml(task.title)}</span>
          <span class="today-item-badge badge-pill" style="background:rgba(${task.category === 'urgent' ? '248,81,73' : '212,175,55'},0.2);color:${task.category === 'urgent' ? 'var(--red)' : 'var(--gold)'};">${getCategoryEmoji(task.category)} ${task.category}</span>
          <span class="today-item-time">${time}</span>
        </div>`;
      });

      buildSection('In Progress', '‚ö°', inProgress, task => {
        return `<div class="today-item" style="border-left-color:var(--orange);">
          <span class="today-item-icon">‚ö°</span>
          <span class="today-item-title">${escapeHtml(task.title)}</span>
          <span class="today-item-badge badge-pill" style="background:rgba(210,153,34,0.2);color:var(--orange);">${getCategoryEmoji(task.category)} ${task.category}</span>
        </div>`;
      });

      buildSection('Notes Added', 'üìù', notesToday, note => {
        const time = note.created_at ? new Date(note.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
        const projectClass = note.project ? `project-${note.project.toLowerCase()}` : 'project-general';
        return `<div class="today-item" style="border-left-color:var(--blue);">
          <span class="today-item-icon">${noteTypeEmojis[note.type] || 'üìù'}</span>
          <span class="today-item-title">${escapeHtml(note.title)}</span>
          <span class="badge-pill badge-project ${projectClass}">${note.project || 'general'}</span>
          <span class="today-item-time">${time}</span>
        </div>`;
      });

      buildSection('Ideas Captured', 'üí°', ideasToday, idea => {
        const time = idea.created_at ? new Date(idea.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
        return `<div class="today-item" style="border-left-color:var(--purple);">
          <span class="today-item-icon">${ideaCategoryEmojis[idea.category] || 'üí°'}</span>
          <span class="today-item-title">${escapeHtml(idea.title)}</span>
          <span class="today-item-badge badge-pill" style="background:rgba(163,113,247,0.2);color:var(--purple);">${idea.category}</span>
          <span class="today-item-time">${time}</span>
        </div>`;
      });

      buildSection('Content Pipeline', 'üì§', contentToday, item => {
        const time = item.created_at ? new Date(item.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
        return `<div class="today-item" style="border-left-color:var(--green);">
          <span class="today-item-icon">${contentTypeEmojis[item.content_type] || 'üì§'}</span>
          <span class="today-item-title">${escapeHtml(item.title)}</span>
          <span class="today-item-badge badge-pill" style="background:rgba(63,185,80,0.2);color:var(--green);">${item.status}</span>
          <span class="today-item-time">${time}</span>
        </div>`;
      });
    }

    init();
  </script>
</body>
</html>
