<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geoffrey's Task Board</title>
  <meta name="description" content="Butler-themed task management for Master Matt">
  <meta name="theme-color" content="#0d1117">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.svg">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --gold: #d4af37;
      --gold-dark: #aa8c2c;
      --gold-light: #f4d03f;
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --bg-hover: #21262d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --red: #f85149;
      --orange: #d29922;
      --green: #3fb950;
      --blue: #58a6ff;
      --purple: #a371f7;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-dark);
      min-height: 100vh;
      color: var(--text);
      overflow-x: hidden;
    }

    .bg-pattern {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 40% 80%, rgba(212, 175, 55, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1500px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* Connection Status */
    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 100;
      transition: all 0.3s;
    }

    .connection-status.connected { background: rgba(63, 185, 80, 0.2); color: var(--green); }
    .connection-status.disconnected { background: rgba(248, 81, 73, 0.2); color: var(--red); }
    .connection-status.syncing { background: rgba(210, 153, 34, 0.2); color: var(--orange); }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .syncing .status-dot { animation: pulse-dot 1s infinite; }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Header */
    header {
      text-align: center;
      padding: 40px 20px;
    }

    .logo {
      font-size: 4rem;
      margin-bottom: 10px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.8rem;
      color: var(--gold);
      font-weight: 600;
      letter-spacing: 1px;
      text-shadow: 0 2px 20px rgba(212, 175, 55, 0.3);
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--text-muted);
      margin-top: 8px;
      font-style: italic;
    }

    /* Geoffrey's wisdom */
    .geoffrey-says {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 16px;
      padding: 20px 30px;
      margin: 30px auto;
      max-width: 700px;
      display: flex;
      align-items: center;
      gap: 20px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .geoffrey-avatar { font-size: 3rem; flex-shrink: 0; }

    .geoffrey-quote {
      font-style: italic;
      color: var(--text);
      line-height: 1.6;
    }

    .geoffrey-quote .signature {
      display: block;
      margin-top: 8px;
      color: var(--gold);
      font-style: normal;
      font-size: 0.9rem;
    }

    /* Category Tabs */
    .category-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .category-tab {
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .category-tab:hover { border-color: var(--gold); color: var(--gold); }

    .category-tab.active {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      color: var(--bg-dark);
      border-color: transparent;
      font-weight: 600;
    }

    /* Board */
    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-top: 20px;
    }

    @media (max-width: 1024px) { .board { grid-template-columns: 1fr; } }

    .column {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }

    .column.drag-over {
      border-color: var(--gold);
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid;
    }

    .column-header h2 {
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .column-header .count {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .column.todo .column-header { border-color: var(--red); }
    .column.todo .column-header h2 { color: var(--red); }
    .column.in-progress .column-header { border-color: var(--orange); }
    .column.in-progress .column-header h2 { color: var(--orange); }
    .column.done .column-header { border-color: var(--green); }
    .column.done .column-header h2 { color: var(--green); }

    .task-list {
      min-height: 150px;
      max-height: 500px;
      overflow-y: auto;
    }

    .task-list::-webkit-scrollbar { width: 6px; }
    .task-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }

    /* Task Cards */
    .task {
      background: var(--bg-hover);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: grab;
      transition: all 0.2s ease;
      border-left: 4px solid var(--gold);
      position: relative;
      overflow: hidden;
    }

    .task::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .task:hover::before { opacity: 1; }

    .task:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .task.dragging { opacity: 0.5; transform: rotate(3deg) scale(1.05); cursor: grabbing; }
    .task.completed { opacity: 0.7; }
    .task.completed .task-title { text-decoration: line-through; color: var(--text-muted); }

    .task-category {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--purple);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .task-title {
      font-size: 1rem;
      margin-bottom: 12px;
      color: var(--text);
      font-weight: 500;
      line-height: 1.4;
    }

    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      flex-wrap: wrap;
      gap: 8px;
    }

    .task-source { font-size: 0.7rem; opacity: 0.6; }
    .task-due { display: flex; align-items: center; gap: 4px; }
    .task-due.overdue { color: var(--red); }
    .task-due.soon { color: var(--orange); }

    .task-priority {
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: 600;
    }

    .priority-high { 
      background: rgba(248, 81, 73, 0.2); 
      color: var(--red);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(248, 81, 73, 0); }
    }

    .priority-medium { background: rgba(210, 153, 34, 0.2); color: var(--orange); }
    .priority-low { background: rgba(63, 185, 80, 0.2); color: var(--green); }

    .task-actions {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      opacity: 0;
      transform: translateY(5px);
      transition: all 0.2s ease;
    }

    .task:hover .task-actions { opacity: 1; transform: translateY(0); }

    .task-actions button {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .task-actions button:hover { background: rgba(212, 175, 55, 0.2); border-color: var(--gold); color: var(--gold); }
    .task-actions button.delete:hover { background: rgba(248, 81, 73, 0.2); border-color: var(--red); color: var(--red); }

    /* Add Task */
    .add-task-btn {
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 2px dashed rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
      margin-top: 15px;
    }

    .add-task-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.05); }

    .add-task-form {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 15px;
      display: none;
      animation: slideDown 0.3s ease;
    }

    .add-task-form.active { display: block; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .add-task-form input,
    .add-task-form select,
    .add-task-form textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }

    .add-task-form textarea { resize: none; height: 80px; margin-bottom: 10px; }
    .add-task-form input:focus, .add-task-form select:focus, .add-task-form textarea:focus { outline: none; border-color: var(--gold); }

    .form-buttons { display: flex; gap: 10px; }

    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--bg-dark); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255, 255, 255, 0.05); color: var(--text-muted); border: 1px solid rgba(255, 255, 255, 0.1); }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 40px;
    }

    @media (max-width: 768px) { .stats { grid-template-columns: repeat(2, 1fr); } }

    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s;
    }

    .stat-card:hover { transform: translateY(-5px); border-color: rgba(212, 175, 55, 0.3); }
    .stat-icon { font-size: 2rem; margin-bottom: 10px; }
    .stat-value { font-size: 2.5rem; font-weight: 600; color: var(--gold); font-family: 'Playfair Display', serif; }
    .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, var(--bg-card), var(--bg-hover));
      border: 1px solid var(--gold);
      border-radius: 16px;
      padding: 20px 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      transform: translateY(150%);
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 1000;
    }

    .toast.show { transform: translateY(0); }
    .toast-icon { font-size: 2.5rem; }
    .toast-content h3 { color: var(--gold); font-size: 1.1rem; margin-bottom: 4px; }
    .toast-content p { color: var(--text-muted); font-size: 0.9rem; }

    .confetti { position: fixed; width: 10px; height: 10px; pointer-events: none; z-index: 999; }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }
    .empty-state p { font-style: italic; }

    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s;
    }

    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loading-spinner { font-size: 4rem; animation: spin 2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .loading-text { margin-top: 20px; color: var(--text-muted); font-style: italic; }

    footer { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 0.9rem; }
    footer a { color: var(--gold); text-decoration: none; }

    .shortcut-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .shortcut-hint kbd { background: var(--bg-hover); padding: 3px 8px; border-radius: 4px; font-family: monospace; }

    /* Custom Tooltips */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--gold);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: normal;
      text-transform: none;
      letter-spacing: normal;
      white-space: nowrap;
      max-width: 280px;
      white-space: normal;
      text-align: center;
      line-height: 1.4;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    [data-tooltip]::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--gold);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1001;
    }

    [data-tooltip]:hover::after,
    [data-tooltip]:hover::before {
      opacity: 1;
      visibility: visible;
    }

    /* Tooltip position variants */
    [data-tooltip-pos="bottom"]::after {
      bottom: auto;
      top: calc(100% + 10px);
    }

    [data-tooltip-pos="bottom"]::before {
      bottom: auto;
      top: calc(100% + 4px);
      border-top-color: transparent;
      border-bottom-color: var(--gold);
    }

    [data-tooltip-pos="left"]::after {
      bottom: auto;
      top: 50%;
      left: auto;
      right: calc(100% + 10px);
      transform: translateY(-50%);
    }

    [data-tooltip-pos="left"]::before {
      bottom: auto;
      top: 50%;
      left: auto;
      right: calc(100% + 4px);
      transform: translateY(-50%);
      border-top-color: transparent;
      border-left-color: var(--gold);
    }

    @media (max-width: 768px) {
      .shortcut-hint { display: none; }
      h1 { font-size: 2rem; }
      .logo { font-size: 3rem; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading">
    <div class="loading-spinner">üé©</div>
    <p class="loading-text">Geoffrey is preparing the board...</p>
  </div>

  <div class="connection-status disconnected" id="connection-status" data-tooltip="Shows sync status with Supabase cloud database. Green = synced, Orange = syncing, Red = offline (using local storage)" data-tooltip-pos="bottom">
    <span class="status-dot"></span>
    <span class="status-text">Offline</span>
  </div>

  <div class="bg-pattern"></div>
  
  <div class="container">
    <header>
      <div class="logo">üé©</div>
      <h1>Geoffrey's Task Board</h1>
      <p class="subtitle">Maintaining order in the chaos, one task at a time</p>
    </header>

    <div class="geoffrey-says" data-tooltip="Geoffrey's daily wisdom ‚Äî refreshes each time you load the page" data-tooltip-pos="bottom">
      <div class="geoffrey-avatar">üßê</div>
      <div class="geoffrey-quote">
        <span id="quote-text">Loading wisdom...</span>
        <span class="signature">‚Äî Geoffrey</span>
      </div>
    </div>

    <div class="category-tabs">
      <button class="category-tab active" data-category="all" data-tooltip="Show all tasks regardless of category">üè† All Tasks</button>
      <button class="category-tab" data-category="work" data-tooltip="9-5 job tasks ‚Äî medical billing, company projects">üíº Work</button>
      <button class="category-tab" data-category="hustle" data-tooltip="Side projects ‚Äî apps, content, revenue streams">üöÄ Side Hustle</button>
      <button class="category-tab" data-category="personal" data-tooltip="Life stuff ‚Äî gym, errands, self-care">üßò Personal</button>
      <button class="category-tab" data-category="urgent" data-tooltip="Drop everything ‚Äî needs immediate attention">üî• Urgent</button>
    </div>

    <div class="board">
      <div class="column todo" data-status="todo">
        <div class="column-header" data-tooltip="Tasks waiting to be started. Drag to In Progress when you begin work.">
          <h2>üìã Awaiting Action</h2>
          <span class="count" data-tooltip="Number of pending tasks" data-tooltip-pos="left">0</span>
        </div>
        <div class="task-list"></div>
        <button class="add-task-btn" onclick="toggleForm(this)" data-tooltip="Click to add a new task, or press 'N' on your keyboard">+ Add a task, sir</button>
        <div class="add-task-form">
          <textarea class="task-input" placeholder="What requires attention, Master Matt?"></textarea>
          <div class="form-row">
            <select class="category-select">
              <option value="work">üíº Work</option>
              <option value="hustle">üöÄ Side Hustle</option>
              <option value="personal">üßò Personal</option>
              <option value="urgent">üî• Urgent</option>
            </select>
            <select class="priority-select">
              <option value="low">üü¢ Low Priority</option>
              <option value="medium" selected>üü° Medium Priority</option>
              <option value="high">üî¥ High Priority</option>
            </select>
          </div>
          <div class="form-row">
            <input type="date" class="due-date">
            <input type="time" class="due-time">
          </div>
          <div class="form-buttons">
            <button class="btn btn-secondary" onclick="toggleForm(this)">Cancel</button>
            <button class="btn btn-primary" onclick="addTask(this)">Add Task</button>
          </div>
        </div>
      </div>

      <div class="column in-progress" data-status="in-progress">
        <div class="column-header" data-tooltip="Tasks currently being worked on. Geoffrey auto-moves tasks here when he starts working.">
          <h2>‚ö° In Progress</h2>
          <span class="count" data-tooltip="Active tasks" data-tooltip-pos="left">0</span>
        </div>
        <div class="task-list"></div>
      </div>

      <div class="column done" data-status="done">
        <div class="column-header" data-tooltip="Completed tasks. Drag here or use arrow buttons to mark done. Triggers confetti! üéâ">
          <h2>‚ú® Accomplished</h2>
          <span class="count" data-tooltip="Completed tasks" data-tooltip-pos="left">0</span>
        </div>
        <div class="task-list"></div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card" data-tooltip="All tasks ever created (todo + in-progress + done)">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="total-tasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-card" data-tooltip="Tasks you've crushed. The number that actually matters.">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-value" id="completed-tasks">0</div>
        <div class="stat-label">Completed</div>
      </div>
      <div class="stat-card" data-tooltip="Completed √∑ Total √ó 100. Aim for progress, not perfection.">
        <div class="stat-icon">üìà</div>
        <div class="stat-value" id="completion-rate">0%</div>
        <div class="stat-label">Success Rate</div>
      </div>
      <div class="stat-card" data-tooltip="Consecutive days completing at least one task. Don't break the chain!">
        <div class="stat-icon">üî•</div>
        <div class="stat-value" id="streak">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>

    <footer>
      <p>Crafted with reluctant excellence by <a href="#">Geoffrey</a> üé©</p>
      <p style="margin-top: 5px; font-size: 0.8rem;">"One does not simply abandon a task list."</p>
    </footer>
  </div>

  <div class="toast" id="toast">
    <div class="toast-icon">üéâ</div>
    <div class="toast-content">
      <h3>Well Done, Sir!</h3>
      <p id="toast-message">Task completed magnificently.</p>
    </div>
  </div>

  <div class="shortcut-hint" data-tooltip="Keyboard shortcuts work when not typing in a field">
    <kbd>N</kbd> New task &nbsp;|&nbsp; <kbd>R</kbd> Refresh &nbsp;|&nbsp; <kbd>?</kbd> Help
  </div>

  <script>
    // ===== SUPABASE CONFIG =====
    const SUPABASE_URL = 'https://arprmkukemtlhglsqgcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycHJta3VrZW10bGhnbHNxZ2NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMjAwNjAsImV4cCI6MjA4NDg5NjA2MH0.KpfUmYynUjCoT6WTKaqJMFXxV6V1fQ_sBJz8QFxIrjM';
    const SCHEMA = 'geoffrey';

    // ===== SUPABASE CLIENT =====
    const supabase = {
      async fetch(endpoint, options = {}) {
        const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
        const headers = {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Content-Profile': SCHEMA,
          'Accept-Profile': SCHEMA,
          'Prefer': options.prefer || 'return=representation',
          ...options.headers
        };
        
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const text = await response.text();
        return text ? JSON.parse(text) : null;
      },

      async getTasks() { return this.fetch(`tasks?order=created_at.desc`); },
      async createTask(task) { return this.fetch(`tasks`, { method: 'POST', body: JSON.stringify(task) }); },
      async updateTask(id, updates) { return this.fetch(`tasks?id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(updates) }); },
      async deleteTask(id) { return this.fetch(`tasks?id=eq.${id}`, { method: 'DELETE' }); },
      async getSettings(key) { const r = await this.fetch(`settings?key=eq.${key}`); return r?.[0]?.value; },
      async updateSettings(key, value) { return this.fetch(`settings?key=eq.${key}`, { method: 'PATCH', body: JSON.stringify({ value, updated_at: new Date().toISOString() }) }); }
    };

    // ===== QUOTES =====
    const geoffreyQuotes = [
      "A task delayed is a task that haunts one's afternoon tea.",
      "I've organized Led Zeppelin's tour schedule. Your tasks are... quaint by comparison.",
      "Might I suggest completing that before it becomes tomorrow's regret?",
      "Excellence is not an act, but a habit. I should know ‚Äî I press my own shirts.",
      "The difference between a good day and a great day is a cleared task list.",
      "I once coordinated a dinner for 47 diplomats. Your three tasks seem manageable.",
      "Procrastination is merely tomorrow's chaos wearing today's pajamas.",
      "Ship it, Master Matt. Ship it before doubt sets in.",
      "Might I remind you ‚Äî revenue-generating apps don't build themselves.",
    ];

    const completionQuotes = [
      "Magnificent work, sir. The task has been vanquished.",
      "Another one bites the dust, as Mr. Mercury would say.",
      "Splendid. Your productivity brings a tear to my eye. Almost.",
      "Task completed with aplomb. I expected nothing less.",
      "Well executed. Perhaps there's hope for you yet.",
    ];

    const emptyStateQuotes = {
      'todo': "Nothing pending? Suspicious. Check your ambitions, sir.",
      'in-progress': "Nothing in flight? Either you're done or in denial.",
      'done': "The accomplishment column awaits your contributions."
    };

    // ===== STATE =====
    let tasks = [];
    let streak = 0;
    let lastCompletionDate = null;
    let currentFilter = 'all';
    let draggedTask = null;
    let isOnline = true;

    // ===== INIT =====
    async function init() {
      document.getElementById('quote-text').textContent = geoffreyQuotes[Math.floor(Math.random() * geoffreyQuotes.length)];
      setupDragAndDrop();
      setupKeyboardShortcuts();
      setupCategoryTabs();
      
      try {
        await loadData();
        setConnectionStatus('connected');
      } catch (error) {
        console.error('Supabase error:', error);
        setConnectionStatus('disconnected');
        loadFromLocalStorage();
        showToast('‚ö†Ô∏è', 'Offline Mode', 'Using local data. Changes won\'t sync.');
      }
      
      document.getElementById('loading').classList.add('hidden');
    }

    function setConnectionStatus(status) {
      const el = document.getElementById('connection-status');
      el.className = `connection-status ${status}`;
      el.querySelector('.status-text').textContent = { connected: '‚òÅÔ∏è Synced', disconnected: 'üì¥ Offline', syncing: 'üîÑ Syncing...' }[status];
      isOnline = status === 'connected';
    }

    async function loadData() {
      setConnectionStatus('syncing');
      tasks = await supabase.getTasks() || [];
      const streakData = await supabase.getSettings('streak');
      if (streakData) { streak = streakData.current || 0; lastCompletionDate = streakData.last_completion_date; }
      renderTasks();
      saveToLocalStorage();
    }

    function loadFromLocalStorage() {
      tasks = JSON.parse(localStorage.getItem('geoffrey-tasks-v2') || '[]');
      streak = parseInt(localStorage.getItem('geoffrey-streak') || '0');
      lastCompletionDate = localStorage.getItem('geoffrey-last-completion');
      renderTasks();
    }

    function saveToLocalStorage() {
      localStorage.setItem('geoffrey-tasks-v2', JSON.stringify(tasks));
      localStorage.setItem('geoffrey-streak', streak.toString());
      if (lastCompletionDate) localStorage.setItem('geoffrey-last-completion', lastCompletionDate);
    }

    // ===== RENDERING =====
    function updateCounts() {
      document.querySelectorAll('.column').forEach(col => {
        const status = col.dataset.status;
        col.querySelector('.count').textContent = getFilteredTasks().filter(t => t.status === status).length;
      });
      const total = tasks.length, completed = tasks.filter(t => t.status === 'done').length;
      document.getElementById('total-tasks').textContent = total;
      document.getElementById('completed-tasks').textContent = completed;
      document.getElementById('completion-rate').textContent = total > 0 ? Math.round((completed / total) * 100) + '%' : '0%';
      document.getElementById('streak').textContent = streak;
    }

    function getFilteredTasks() {
      return currentFilter === 'all' ? tasks : tasks.filter(t => t.category === currentFilter);
    }

    function getCategoryEmoji(cat) {
      return { work: 'üíº', hustle: 'üöÄ', personal: 'üßò', urgent: 'üî•' }[cat] || 'üìå';
    }

    function formatDueDate(d) {
      if (!d) return null;
      const due = new Date(d), diff = Math.ceil((due - new Date()) / 86400000);
      if (diff < 0) return { className: 'overdue', text: `${Math.abs(diff)}d overdue` };
      if (diff === 0) return { className: 'soon', text: 'Due today' };
      if (diff === 1) return { className: 'soon', text: 'Due tomorrow' };
      if (diff <= 3) return { className: 'soon', text: `${diff} days left` };
      return { className: '', text: due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) };
    }

    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    function createTaskElement(task) {
      const div = document.createElement('div');
      div.className = 'task' + (task.status === 'done' ? ' completed' : '');
      div.draggable = true;
      div.dataset.id = task.id;
      
      const dueInfo = formatDueDate(task.due_date);
      const dueHtml = dueInfo ? `<span class="task-due ${dueInfo.className}">üìÖ ${dueInfo.text}</span>` : '';
      const srcIcon = { telegram: 'üí¨', api: 'üîå' }[task.source] || 'üåê';

      div.innerHTML = `
        <div class="task-category">${getCategoryEmoji(task.category)} ${task.category}</div>
        <div class="task-title">${escapeHtml(task.title)}</div>
        <div class="task-meta">
          ${dueHtml}
          <span class="task-priority priority-${task.priority}">${task.priority}</span>
          <span class="task-source" title="via ${task.source}">${srcIcon}</span>
        </div>
        <div class="task-actions">
          <button onclick="editTask('${task.id}')">‚úèÔ∏è</button>
          <button onclick="moveTask('${task.id}', 'prev')">‚óÄÔ∏è</button>
          <button onclick="moveTask('${task.id}', 'next')">‚ñ∂Ô∏è</button>
          <button class="delete" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
        </div>
      `;

      div.addEventListener('dragstart', e => { draggedTask = e.target; e.target.classList.add('dragging'); });
      div.addEventListener('dragend', e => { e.target.classList.remove('dragging'); document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over')); draggedTask = null; });

      return div;
    }

    function renderTasks() {
      const filtered = getFilteredTasks();
      document.querySelectorAll('.task-list').forEach(list => {
        const status = list.closest('.column').dataset.status;
        const statusTasks = filtered.filter(t => t.status === status);
        list.innerHTML = statusTasks.length === 0 
          ? `<div class="empty-state"><div class="icon">${status === 'done' ? 'üèÜ' : 'üì≠'}</div><p>${emptyStateQuotes[status]}</p></div>`
          : '';
        statusTasks.forEach(t => list.appendChild(createTaskElement(t)));
      });
      updateCounts();
    }

    // ===== TASK OPS =====
    function toggleForm(btn) {
      const col = btn.closest('.column'), form = col.querySelector('.add-task-form'), addBtn = col.querySelector('.add-task-btn');
      form.classList.toggle('active');
      addBtn.style.display = form.classList.contains('active') ? 'none' : 'block';
      if (form.classList.contains('active')) form.querySelector('.task-input').focus();
    }

    async function addTask(btn) {
      const form = btn.closest('.add-task-form');
      const title = form.querySelector('.task-input').value.trim();
      if (!title) return;
      
      const dueDate = form.querySelector('.due-date').value;
      const dueTime = form.querySelector('.due-time').value;
      const task = {
        title,
        category: form.querySelector('.category-select').value,
        priority: form.querySelector('.priority-select').value,
        status: 'todo',
        due_date: dueDate ? (dueTime ? `${dueDate}T${dueTime}:00` : `${dueDate}T23:59:59`) : null,
        source: 'web'
      };

      btn.disabled = true;
      try {
        if (isOnline) {
          const [created] = await supabase.createTask(task);
          tasks.unshift(created);
        } else {
          task.id = 'local-' + Date.now();
          task.created_at = new Date().toISOString();
          tasks.unshift(task);
        }
        saveToLocalStorage();
        renderTasks();
        form.querySelector('.task-input').value = '';
        form.querySelector('.due-date').value = '';
        form.querySelector('.due-time').value = '';
        toggleForm(btn);
        showToast('üìù', 'Task Added', 'I shall keep a watchful eye on this one.');
      } catch (e) { console.error(e); showToast('‚ùå', 'Error', 'Failed to save task.'); }
      btn.disabled = false;
    }

    async function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        if (isOnline && !id.startsWith('local-')) await supabase.deleteTask(id);
        tasks = tasks.filter(t => t.id !== id);
        saveToLocalStorage();
        renderTasks();
      } catch (e) { showToast('‚ùå', 'Error', 'Failed to delete.'); }
    }

    async function editTask(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      const newTitle = prompt('Edit task:', task.title);
      if (newTitle?.trim()) {
        try {
          if (isOnline && !id.startsWith('local-')) await supabase.updateTask(id, { title: newTitle.trim() });
          task.title = newTitle.trim();
          saveToLocalStorage();
          renderTasks();
        } catch (e) { showToast('‚ùå', 'Error', 'Failed to update.'); }
      }
    }

    async function moveTask(id, dir) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      const statuses = ['todo', 'in-progress', 'done'];
      const idx = statuses.indexOf(task.status);
      const newStatus = dir === 'next' && idx < 2 ? statuses[idx + 1] : dir === 'prev' && idx > 0 ? statuses[idx - 1] : task.status;
      if (newStatus !== task.status) await updateTaskStatus(task, newStatus);
    }

    async function updateTaskStatus(task, newStatus) {
      const wasDone = task.status === 'done';
      try {
        const updates = { status: newStatus, completed_at: newStatus === 'done' ? new Date().toISOString() : null };
        if (isOnline && !task.id.startsWith('local-')) await supabase.updateTask(task.id, updates);
        task.status = newStatus;
        task.completed_at = updates.completed_at;
        if (newStatus === 'done' && !wasDone) await celebrateCompletion();
        saveToLocalStorage();
        renderTasks();
      } catch (e) { showToast('‚ùå', 'Error', 'Failed to update.'); }
    }

    async function celebrateCompletion() {
      const today = new Date().toDateString(), yesterday = new Date(Date.now() - 86400000).toDateString();
      if (lastCompletionDate !== today) {
        streak = lastCompletionDate === yesterday ? streak + 1 : 1;
        lastCompletionDate = today;
        if (isOnline) try { await supabase.updateSettings('streak', { current: streak, last_completion_date: today }); } catch (e) {}
        saveToLocalStorage();
      }
      showToast('üéâ', 'Task Complete!', completionQuotes[Math.floor(Math.random() * completionQuotes.length)]);
      createConfetti();
    }

    // ===== UI =====
    function showToast(icon, title, msg) {
      const t = document.getElementById('toast');
      t.querySelector('.toast-icon').textContent = icon;
      t.querySelector('h3').textContent = title;
      t.querySelector('#toast-message').textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 4000);
    }

    function createConfetti() {
      const colors = ['#d4af37', '#f4d03f', '#aa8c2c', '#fff', '#3fb950'];
      for (let i = 0; i < 50; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.cssText = `left:${Math.random()*100}vw;top:-10px;background:${colors[Math.floor(Math.random()*colors.length)]};border-radius:${Math.random()>.5?'50%':'0'}`;
        document.body.appendChild(c);
        c.animate([
          { transform: 'translateY(0) rotate(0)', opacity: 1 },
          { transform: `translateY(100vh) rotate(${Math.random()*720}deg)`, opacity: 0 }
        ], { duration: 2000 + Math.random() * 2000, easing: 'ease-out' }).onfinish = () => c.remove();
      }
    }

    // ===== DRAG & DROP =====
    function setupDragAndDrop() {
      document.querySelectorAll('.column').forEach(col => {
        col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drag-over'); });
        col.addEventListener('dragleave', e => { if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over'); });
        col.addEventListener('drop', async e => {
          e.preventDefault();
          col.classList.remove('drag-over');
          if (draggedTask) {
            const task = tasks.find(t => t.id === draggedTask.dataset.id);
            if (task && task.status !== col.dataset.status) await updateTaskStatus(task, col.dataset.status);
          }
        });
      });
    }

    // ===== TABS & KEYBOARD =====
    function setupCategoryTabs() {
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.category;
          renderTasks();
        });
      });
    }

    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (e.key === 'n' || e.key === 'N') {
          const btn = document.querySelector('.column.todo .add-task-btn');
          if (!document.querySelector('.column.todo .add-task-form').classList.contains('active')) toggleForm(btn);
        }
        if (e.key === 'r' || e.key === 'R') loadData().catch(() => loadFromLocalStorage());
      });
      document.querySelectorAll('.task-input').forEach(input => {
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addTask(input.closest('.add-task-form').querySelector('.btn-primary')); }
        });
      });
    }

    init();
  </script>
</body>
</html>
